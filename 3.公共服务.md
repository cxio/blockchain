# 公共服务

如果把P2P网络看作一个系统，依P2P网络运行的逻辑，我们可以分解出一些通用的公共服务部分。


## 服务的分解

1. **节点发现**：最基础的P2P网络服务，所有的P2P节点都需要。
2. **STUN服务**：对于处于NAT内网的节点，NAT探测和打洞协助是必不可少的。
3. **数据存储**：一个开放式数据存储网络，提供P2P网络的公共数据层。
4. **交易查询**：仅用于区块链节点，可分担普通节点的硬件需求，大幅降低进入的门槛。

因为有了区块链代币全网直付的能力，对公共服务的激励就变得可行了。


### 服务关系图

<img src="images/serv4nets-840.svg" width="840" alt="服务关系图"  style="padding:20px;" />

**图解：**
- 基网是所有服务子网或应用子网的底层支持，提供任意节点发现的功能。
- Peer 为区块链应用节点，同类相连成网。同时也连接公共服务节点获得功能支持。
- Blockqs、Depots、STUN 服务节点自我组网，同时也向连入的Peer提供服务。



## 节点发现（基网）

通过一个精简的P2P网络，植入广播搜寻的机制，任何一个应用节点都可以找到自己的同类或所需的服务类节点。

基网是一个P2P节点的自由市场，项目详见：[github.com/cxio/p2p](https://github.com/cxio/p2p)。

服务节点会向连入的应用节点提供自己的区块链地址，如果应用是区块链类型，可能会有正常的利益分配。否则就只能是公益性质或由应用自愿捐赠了。


### 吝啬的区块链

对公共服务节点的奖励不是强制的（没有简单的约束办法），自私的区块链可能不会提供报酬。这很糟糕，但可能也没有想象的那么严重。

区块链应用在铸造收益里划出一部分作为外部奖励，是一种损失吗？

区块链的价值来源于用户对它的信任、观感和使用，一条吝啬的区块链会获得好感吗？如果有其它公允的区块链竞争呢？或许独特的技术优势是保护它吝啬的一道墙，但如果技术开源……

划出一部分区块收益奖励外部，并不是一种损失，因为它的价值主要由外部赋予。



## 数据驿站（Depots）

区块链无需信任，它隐含的意思其实是：*区块链本身就是信任*。

本设计试图用区块链创建一个通用的信用系统，因此需要包含大量的数据。但区块链去中心化的P2P逻辑使得每一个节点都需要面对完整的数据集，既冗余也负担沉重。

因此一个独立的、可共享的*数据网络层*可能是个好办法。

数据网络由数据驿站组成，驿站之间通过数据信令的沟通，获知数据的存在性和紧缺性，并由此做出存储决策。这是一种开放式的存储协调机制。

数据网络主要用于存储区块和交易中的附件数据，也可用于其它大尺寸数据的存储和分享。



### 数据的查询

数据的查询由基网的通用广播搜寻机制完成。

这是一种定制实现，每一种应用或服务子网都有自己对该功能的定制。


### 数据的紧缺性感知

在数据查询请求的广播过程中，拥有目标数据的节点会回应并终止转播，没有数据的节点则会将请求包跳数加一后转播。

这样，通过跳数的大小，实际上节点就可以知道请求包广播的大致距离：距离越远，说明数据越稀少（紧缺）。于是，节点就可以据此评估数据的紧缺性，并根据自己的存储策略决定是否补充存储。

这是一种简单的全网存储协调机制，没有统一的控制。当然也因此，没有绝对的保证。

> #### 关于跳数作弊
> 应用节点可能因为某种原因，设置请求的起跳数不为零，这是允许的（比如隐藏起点）。
> 评估节点并不需要完全仰赖于此，它有自己的主动性：自己创建一个请求，从零起跳……即可知道最终目标的距离。


### 数据心跳

数据的紧缺性感知依赖于查询请求，这对某些需求不强的数据不友好。

如果有一些公益性的节点，对这些冷门数据执行系统性的探查……将可以解决这一问题。探查是一个类似查询的请求，但不要求回复。如果你的数据是区块链上的附件，公益节点就有了一个明确的目录。

这种探查是周期性持续进行的，就像人的心跳……所以这里称之为**数据心跳** :)


### 附：关于数据上传

对于应用自己的原创数据，数据网络上是没有的。

如果应用节点向数据网络发送该数据的查询……它会触发某些节点的补存行为，于是应用就可以充当数据源，主动上传数据。


### 项目

数据驿站：[github.com/cxio/depots](https://github.com/cxio/depots)



## 区块查询（Blockqs）

即对区块中交易数据的查询，这需要快速响应。

查询主要包括：

- **脚本**：通用的交易及其输出项检索。
- **脚本集**：获取目标交易的全部输出项。
- **交易**：检索完整的交易数据。
- **UTXO**：查询目标是否已花费。
- **UTXO集**：获取当前UTXO集数据。
- **UTCO**：查询目标信用凭证的状态。
- **UTCO集**：获取当前UTCO集数据。
- **交易ID组**：主要用于普通用户检索账号关联的交易。
- **附件**：小于10MB的附件（通常<=2MB），或者大附件的分片索引文件（类Torrent）。

> **注：**
> 完整的区块数据或大于10MB的附件应交由Depots文件分享服务执行。

Blockqs节点会接入自己所服务的区块链网络，实时接收交易数据和存储。初上线的服务器节点可通过Depots服务请求历史数据。

服务节点在与区块链应用节点连接时，会提供该区块链的自己的账户地址，以接收可能有的收益分配。


### 项目

区块查询：[github.com/cxio/blockqs](github.com/cxio/blockqs)



## STUN服务（stun2p）

NAT探测和打洞服务网络，支持UDP协议的P2P连接。

项目详见：[github.com/cxio/stun2p](https://github.com/cxio/stun2p)。




--------------------------------------------------------------------------

上一篇：[共识：端点约定](2.共识-端点约定.md)<br>
下一篇：[激励机制](4.激励机制.md)<br>
