# 公共服务

如果我们把P2P网络看作一个系统，依P2P网络运行的逻辑，我们可以分解出一些通用的公共服务部分。

这些服务部分自成网络，任何人都可以参与，分享自己的计算能力和资源。公共服务网络与应用网络相互协作、依赖，共同构成一个网络间协作的P2P世界。这或许很美好，也更强壮！


## 服务的分解

1. **节点发现（Findings）**：最基础服务，负责应用节点的登记、缓存、中介，同时也提供NAT探测和打洞协助。
2. **数据驿站（Depots）**：一个数据信令网络，用于协调任意数据的存在性判断、存储和查询。这是一个容器，内部的微服务提供具体能力。
3. **区块查询（Blockqs）**：数据驿站的微服务。分离区块链数据的存储负担，并提供高效查询（Web Server）。
4. **档案存储（Archives）**：数据驿站的微服务。存储任意的大数据，包括区块链上的附件（P2P App）。

公共服务主要服务于区块链应用，区块链应用负责对公共服务的激励。当然，作为一种公益自愿，公共服务也可以服务于非区块链应用。

> **注：**
> 一个区块查询节点通常仅服务于单一区块链，以保证高性能。


### 服务关系图

<img src="images/serv4nets-920x620.svg" width="920" alt="服务关系图"  style="background-color:#333; padding:20px; border-radius: 20px;" />

**图解：**
- Peer为区块链应用节点，同类相连，同时也连接公共服务节点（F, D）。
- Findings节点自我组网，是其它所有类型应用（包括Depots）节点的连系中介。
- Depots节点自我组网，负责任意数据的存储和供应，是一种分享和均衡的逻辑。可视为P2P世界的数据层。



## 节点发现（Findings）

提供各种应用类型节点的登记，维护一个节点连系信息的缓存池。对于UDP通讯节点，提供NAT探测和打洞协助服务。

连系信息包括：

- 应用类型：depots:xx | blockchain:xx | app:xx | findings:xx
- 公网地址：IP:Port
- NAT 层级：Pub/FullC | RC | P-RC | Sym
- 会话公钥：用于密钥交换。应用启动后自动创建，在当前运行期有效。

> **注：**
> 其中后两项用于采用UDP协议的节点，前两项则通用于TCP和UDP。
> NAT探测服务通过简单的端点协作，代替传统STUN服务的双IP需求。

在具体的应用端，用户应当先启动一个Findings客户端，等待它搜寻同类节点完成组网。然后应用就可以通过它获得目标类型应用的节点信息了。

如果该客户端内部集成了有效的Fiindings公共节点信息，或者用户可以配置有效的公共Findings节点，组网会很快。否则可能是一个比较漫长的过程，Findings的实现会通过*暴力发现*的方式去寻找Findings网络。

> **提示：**
> 如果Findings网络巨大，暴力发现可能并不需要太长的时间。
> 应用端也可以提前挂机，当Findings客户端组网成功之后，历史记录会变得有价值。

Findings服务器会向应用节点提供自己的区块链账户地址。如果应用是区块链类型，通常有正常的利益分配，非此，则是靠应用自愿捐赠了。


### 吝啬的区块链

对公共服务节点的奖励不是强制的，因为没有简单的办法去约束。自私的区块链可能不会支付报酬……这很糟糕，但可能也没有想象的那么严重。

区块链应用在铸造收益里划出一部分作为外部奖励，是一种损失吗？

区块链的价值来源于用户对它的信任和观感（技术终归会成熟），一条吝啬的区块链和一条公允的区块链，谁的观感更好、更有竞争力呢？……或许我们可以有信心！


### 项目

节点发现：[github.com/cxio/findings](https://github.com/cxio/findings)



## 数据驿站（Depots）

区块链无需信任，隐含的意思其实就是：*区块链本身就是信任*。Bitcoin用它来构建数字黄金（BTC），正是基于这种本然的特质。

本设计试图用区块链来创建一个通用的信用系统，需要包含大量的数据。但区块链去中心化的P2P属性，使得每一个节点都需要管理完整的数据，极其冗余和浪费。因此一个独立的、可共享的**数据网络**可能是个好办法。

数据网络由数据驿站组网而成，驿站之间负责数据信令的沟通，获知数据的存在性和紧缺性，并提供数据存储和供给的内部服务。**注**：数据驿站是一个容器，内部包含负责具体数据存储和分享的微服务。

数据网络也是去中心化的P2P网络，它支持一种开放式的存储。


### 数据的查询

对于一个应用，它可以把自己需要管理的数据只保留ID（数据哈希），然后把实际的数据内容让数据网络来存储。

当应用需要某个数据时，它向数据网络发送请求，包含该数据的ID，以及必要的自身的联系信息。当数据网络中某个拥有该数据的节点收到请求后，会返回自身的联系信息。于是应用节点与目标节点建立连系，传输数据。


### 数据的紧缺性感知

在数据查询请求的广播过程中，没有该数据的节点会转播请求，拥有该数据的节点会回应并终止转播。

如果请求每转播一次就在请求包中递增一个跳数，通过跳数的大小，实际上节点就可以感知请求广播的距离。距离越远说明数据越稀少（紧缺），这样，节点就可以根据该数据的紧缺性和自己的存储策略，决定是否补充存储该数据。

这是一种简单的全网存储协调机制，没有统一控制，因此也没有绝对的保证。

> #### 关于跳数作弊
> 应用节点可能因为某种原因，让请求初始的跳数就不为零，这是允许的（比如隐藏起点）。
> 评估数据紧缺性的节点有自己的主动性，它可以自己创建一个请求，从零起跳……看回应的距离是多远。


### 数据心跳

数据的紧缺性感知依赖于查询请求，这对某些需求不强的数据并不友好。

如果有一些公益的节点，可以对这些冷门数据执行系统性的探查……就可以解决这一问题。探查是一个类似于查询的请求，但并不要求回复。如果你的数据是区块链上的附件，公益节点就有了一个明确的目录。

这种探查是周期性永续执行的，就像一个人的心跳……所以这里称它为**数据心跳**。


### 附：数据上传

对于应用自己的原创数据，数据网络上是没有的。

如果应用节点向数据网络发送该数据的查询……它会触发某些节点的补存行为。于是，应用就可以充当数据源，主动上传数据了。


### 项目

数据驿站：[github.com/cxio/depots](https://github.com/cxio/depots)



## 区块查询（Blockqs）

作为数据驿站的内部微服务，区块查询服务负责特定区块链的快速查询工作。主要包括：

- **脚本**：通用的交易及其输出项检索。
- **脚本集**：获取目标交易的全部输出项。
- **交易**：检索完整的交易数据。
- **UTXO**：查询目标是否已花费。
- **交易ID组**：主要用于普通用户检索账号关联的交易。
- **附件**：小于2MB的小附件（可选2~10MB），或者大附件的分片索引文件（类Torrent）。

> **注：**
> 完整的区块数据或大于10MB的附件将交由Archives文件分享服务完成。

Blockqs节点会接入自己所负责的区块链的网络，实时接收交易数据（无需验证），实现数据的存储。初上线的服务器节点可通过同机Archives服务向数据网络请求历史数据。

服务节点在与区块链应用节点连接时，会提供自己的该区块链的账户地址，以接收可能的收益分配。


### 项目

区块查询：[github.com/cxio/blockqs](github.com/cxio/blockqs)



## 档案存储（Archives）

大尺寸数据的文件分享应用（P2P），作为数据驿站的内部微服务，主要用于区块链系统（与Blockqs协作），但也可用于其它非区块链应用。

因为是P2P分享类型，所以缺乏实时性。主要用于历史类存档数据的获取和分享。档案的逻辑是不可修改，只有初始写入和日常检索，所以长远来看，一次性写入的*固化存储*逻辑是适用的。

与Blockqs服务相同，Archives节点与数据请求者相连时，也会提供自己的区块链账户地址。


### 项目

档案存储：[github.com/cxio/archives](github.com/cxio/archives)



--------------------------------------------------------------------------

上一篇：[共识：端点约定](2.共识-端点约定.md)<br>
下一篇：[激励机制](4.激励机制.md)<br>
