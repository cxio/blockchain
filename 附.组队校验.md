# 组队校验

区块链去中心化的运作模式实际上是一种「单机」逻辑，如果交易量太大，硬件性能不足的端点很难成为一个节点。

这是限制区块链系统交易规模难以壮大的主要原因。

单机去中心化的庞大冗余实际上没有必要，分权已经足够。交易天生独立，因此以交易为单元切分，由众多节点分担校验并协同工作，是十分合理的。


## 基本规则

协同工作的节点群可以视为一个逻辑上的单体：**校验组**。


### 保障措施

校验组内以 *冗余校验* 和 *扩展复核* 为保障措施，避免离散的校验节点的错误。

更进一步，如果一个校验组传递了一笔错误的交易，其它校验组也会即时反馈。这样，可能的失误很难持续存在，通常很快被纠正。


### 自由组队

一个节点应当可以自由加入任何一个校验组，能力强的单机甚至可能同时加入多个校验组。


### 半开放性

校验组内部的成员间需要一定程度的协作，因此有部分信任要求，可能需要注册。但不同校验组之间依然是自由的P2P，这算是一种半开放吧。



## 角色分配

1. **管理层**：负责组内交易校验工作的分发、冗余控制、合法交易汇总、节点业绩记录，以及与外部的区块交互等。
2. **守卫者**：接收外部传入的交易，执行「首领校验」，提交验证通过的交易到管理层，并传递给其它组的守卫者。
3. **校验员**：向管理层请求交易，执行完整校验，无论结果如何都向管理层提交反馈，同时向其它组的守卫者传送校验合法的交易。

<img src="images/checkteam-1180x800.svg" width="1280" alt="校验组成员内外关系图" style="background-color:#333; padding:20px; border-radius: 20px;">


#### 附：UTXO缓存器

缓存当前UTXO集合（以及管理者脚本）并提供查询服务。这是组内的公共服务，方便守卫者和校验员使用。

通常，如果交易验证通过，管理层也会把它发送到缓存器暂存下来。缓存器自身会检查是否为双花，并即时反馈到管理层。

> **注：**
> 缓存器通常由管理层直接运作，双花的全网警告也由管理层负责。


### 管理层

管理层里有两个角色：**广播**、**调度**。

不同校验组的管理层之间相互连接，完成对区块整体的验证和广播。


#### 广播

- 如果接收到铸造候选者的铸造申请，执行相关交互流程。打包并发布区块。
- 如果没有铸造区块，接收其它组发布的区块、补足差异部分，验证并转播。

> **注：**
> 广播者可能自行负责少量差异部分交易的验证工作，但也可能分派下去（委托调度者）。


#### 调度

- 接收守卫者传入的准合法交易（通过首领校验），存入待验证交易池。
- 接收校验员的工作申请派发准合法交易，让它们执行完整的合法性验证，并根据情况评估和执行可能的扩展复核。
- 记录组内各成员的工作业绩，便于最终的酬劳分配。

> **注：**
> 在派发准合法交易给校验员时，会有适当冗余。
> 调度者会将当前合法的交易同步给广播者，以便它能及时打包或验证区块。


#### 连接关系

- **组内**：守卫者、校验员。
- **对外**：其它校验组的管理层（广播者）。


### 守卫者

负责交易的进入把关。

守卫者与外部其它校验组的守卫者和校验员连接，接收它们的交易，执行首领校验（仅验证交易中首笔输入），完成交易的全网快速广播。

守卫者也会管理一个黑名单，那些首领校验通过但最终非法的交易，其首领输入会被记录。


#### 连接关系

- **组内**：管理层。提交初步验证合法的交易。
- **对外**：守卫者、校验员。交易的进入把关。


### 校验员

执行交易的完整校验工作。

校验员向管理层请求校验任务，执行完整验证并反馈结果。与其它组的守卫者建立连接并提供已验证合法的交易。


#### 实现参考

校验员并不清楚管理层派发的验证是普通验证还是复核验证。这可以更好地预防可能的恶意行为。

对于需要太多计算量的交易，校验员可以拒绝并返回*负载过高*通知。管理层如果接到多个相同反馈，可能对交易进行冷处理。


#### 连接关系

- **组内**：管理层。申请并接受工作派发。
- **对外**：守卫者。传递自己验证合法的交易。


### 附：首领校验

对于接收到的交易，仅验证其首笔输入，合法即通过，这就是首领校验。

首领校验可以加快交易在网络上的传播，但攻击者可能构造大量首笔输入合法但后续非法的交易进行**洪流消耗**攻击。因此这里有一些规则：

- **约束**：首笔输入必须是币金，且为全部币金输入里币权最大者。
- **黑名单**：对于最终完整验证失败的交易，该首笔输入会进入黑名单，临时冻结。

这样可以限制攻击者的资源可用性，避免密集持续的攻击。黑名单的冻结时间可能为**24**小时。



## 安全保障

### 冗余校验

每一笔交易都会由多名校验员执行完整的验证。

对于同一笔交易，如果全都反馈为合法，则为合法。如果至少有一名判断为非法，则纳入扩展复核的范畴。

> **注：**
> 校验员的冗余度通常不低于2，但这取决于校验组自己的决策。


### 扩展复核

对于存在合法性分歧的交易，管理层会将它们派发给另一些绩效更好的校验员。**注**：依然也会有冗余。

- **一级复核**：零报错，交易合法。超过半数报错，交易非法。低于半数，进入二级复核。
- **二级复核**：只要有报错，即视为非法。

复核判断为非法的交易并非就再也没有机会了。如果其它校验组验证合法且打包进入区块，当该区块同步到当前组时，该交易会被重新验证。


### 组间反馈

校验员可以直接对外传递自己验证合法了的交易，这可以加速交易的传播。

如果守卫者接收的交易被本组验证为非法，也会即时反馈到其发送者（组外），此时校验员可以再次重新验证一次。这会大大强化验证的可靠性。



## 铸造者

铸造竞争是自由的，不论是管理层、守卫者还是校验员，它们都可以参与铸造预选（择优竞争）。

管理层并不清楚哪些节点拥有铸造资格。一位铸造者可能同时参与多个校验组工作，其签名哪个校验组的区块并不确定。而且逻辑上，他还可以同时签名多个区块……

这会带来混乱，因此有如下规则。


### 低收益原则

铸造者同时签署多个区块的原因可能是希望更多的收益。因此这里的规则是：

**对于同一铸造者，其签名的收益最低的区块有效**。

这样可以避免铸造者多签，虽然他签署的区块可能有错（非法），但这由校验组管理层负责，是另一个问题。

实际上，这一规则还能让管理层失去延迟出块的动机，因为本组的铸造者可能也参与了其它组的工作，所以及时出块才是有利的。


### 信息的分离

Coinbase交易由铸造者创建，有着固定的结构，比如不同的地址接受不同比例的分成。

管理层需要检查CoinBase交易是否符合要求，并将之合并到区块的交易集。同时返回交易集的哈希校验树根和UTXO指纹，供铸造者签名。

下图展示了哈希校验树和区块头以及签名的关系：

<img src="images/hashcheck-1050.svg" width="1050" alt="哈希校验树结构" style="background-color:#333; padding:10px 30px; border-radius: 20px;" />

铸造者不知道区块的全局性信息（哈希树根），他只能相信管理层提供的待签名消息，但他可以验证自己构建的Coinbase交易是否在其中。这是一种有意的信息分离，相互牵制，避免任何一方作弊。

铸造流程大致如下：


#### 铸币申请

节点检查自己是否在择优池中，若是，向管理层提交择优证明，请求创建铸币交易（Coinbase）。

1. 管理层验证请求，向申请者提供区块的交易费、校验组收益地址、公共服务地址、铸币量等必要信息。
2. 铸造者按规则构造Coinbase交易，向管理层提交。
3. 管理层验证提交的Coinbase交易、打包区块。然后向申请者提供区块的交易哈希树根、UTXO指纹、校验树关联哈希等信息。


#### 签署区块

铸造申请者接收到返回的相关数据后：

1. 验证自己创建的Coinbase交易是否在其中（哈希树校验）。
2. 签署区块消息（哈希树根+UTXO指纹），提交给管理层。
3. 管理层验证签名，计算CheckRoot，构造区块头，对外发布区块。

> **注：**
> 区块头由管理层创建，让管理层更多一些自主性（如版本控制）。


### 区块发布

考虑网络效率，区块的发布分三段逻辑：

1. 广播区块证明。提供最少的证明性数据：Coinbase交易、Coinbase哈希验证序列（关联哈希）、铸造者签名、区块头等。
2. 发布区块概要。包含区块全部交易的ID序列（可优化设计）。
3. 同步交易数据。区块收录的全部交易的数据。各节点应当仅有少量的交易缺失，补足即可。


#### 同步优化

发布区块概要时，可以优化同步的逻辑，减少网络传输的数据量。

1. 每个交易ID仅截取前12字节，按源顺序打包传递。假设64k笔交易，数据量：`64*12 = 768` KB。
2. 接收者对比交易ID片段，如果缺失则申请补充完整，如果片段存在重复（很难），则重复的部分皆请求获取。
3. 计算校验树根（若有重复则有多个根），与前期接收到目标校验树根对比，完成区块核验。


### 围观者参与

逻辑上，铸造者竞争与校验工作无关。

因此如果希望铸凭交易的规模足够庞大，充分竞争（提高安全性），应当有一种更为开放的机制。这就是**围观者**参与的逻辑：

*校验组允许不参与校验工作的节点也加入进来，共同参与铸造竞争*。

围观者需要自己构建择优池，仅与管理层连接可能已足够。


#### 交易量约束

理论上，铸造者只要知道上一区块ID和当前UTXO集指纹，就可以铸造一个只有Coinbase交易的空区块，而不需要校验组的协助。这称之为自私铸造，但逻辑上它是合法的。

为了避免这种情况，设计中需要加入一条有关交易量的约束：

**如果候选区块的币权销毁 `3` 倍于最高权重的主区块，则候选区块胜出。**

也即，自私铸造至少需要验证大约 `1/3` 的交易才能被通过。这对于围观者或单个的校验员并不现实。同时，如果主区块不是自私铸造，候选区块的交易量基本上就不可能3倍于它。



## 附注

### 铸造者最低开销原则

无需参与校验工作的铸造者很可能是一名围观者，硬件性能不足，设计应当充分考虑这一点。

铸造者仅需完成如下工作：

1. 签名择优凭证 => 向管理层证明自己。
2. 构造合规的Coinbase交易 => 提交给管理层。
3. 确认Coinbase未被篡改，签署区块，提交给管理层。

> **注：**
> 区块签署者也称为*铸凭者*。一个组员铸凭者会有两份收益：铸造分成和工作报酬。


### 关于最优规模

校验组的规模并非越大越好。

单个区块收集的交易是有限的，如果按6分钟一个区块，每块64k笔交易计算，每秒约**182**笔交易负载，可能**50-60**个节点就足够了。

校验员对交易的认领是自由的，能力强的可以多处理一些，反之则量力而行，这是自适应的。


### 一些不足

- 铸造者需要把收益发送到管理层指定的地址，这需要信任。
- 如果管理层自己的铸凭交易获胜，没有办法禁止他们独享收益的自私行为。



--------------------------------------------------------------------------

上一篇：[脚本基础指令集](6.脚本基础指令集.md)
