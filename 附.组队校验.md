# 组队校验

区块链去中心化的运作模式实际上是一种「单机」逻辑，如果交易量太大，硬件性能不足的端点很难成为一个合格的节点。

这是限制区块链系统交易规模壮大的一个主要原因。

单机去中心化的庞大冗余实际上没有必要，分权已经足够。交易天生独立，因此以交易为单元切分，由众多节点分担校验并协同工作，是自然且合理的。


## 基本规则

**校验组**就是一个协同工作的节点群，它可以被视为一个逻辑上的单体。


### 保障措施

校验组内以 *冗余校验* 和 *扩展复核* 为保障措施，避免离散的校验节点的错误。

更进一步，如果一个校验组传递了一笔错误的交易，其它校验组也会即时反馈。这样，可能的失误很难持续存在，通常很快会被纠正。


### 自由组队

一个节点应当可以自由的加入任何一个校验组，能力强的单机通常可以同时加入多个校验组。


### 微中心的半开放性

校验组内部的成员有角色分配，需要密切协作，因此有一定程度的信任需求。但不同校验组之间依然是自由的P2P逻辑——以校验组为微中心的去中心化。

并且本设计中，校验组虽然是中心化的逻辑，但不同校验组内部的成员之间依然是自由互连的。


### 去中心化

一个校验组承载着完整区块的验证，就像一个全节点一样。但创建校验组是容易的，除了管理层稍高要求的硬件，没有任何其它限制。

如果本区块链网络有足够的吸引力，千千万万的校验组被创建并参与进来，是完全可能的。没有任何强制的外力或规则限制进入。



## 角色分配

1. **管理层**：负责组内交易校验工作的分发、冗余控制、合法交易汇总、节点业绩记录，以及与外部的区块交互等。
2. **守卫者**：接收外部传入的交易，执行「首领校验」，提交验证通过的交易到管理层，并传递给其它组的守卫者。
3. **校验员**：向管理层请求交易，执行完整校验，无论结果如何都向管理层提交反馈，同时向其它组的守卫者传送校验合法的交易。

<img src="images/checkteam-1180x800.svg" width="1280" alt="校验组成员内外关系图" style="background-color:#333; padding:20px; border-radius: 20px;">


#### 附：UTXO/UTCO 缓存器

缓存当前UTXO/UTCO集合，并提供查询服务。这是组内的公共服务，方便其它成员使用。

UTCO 缓存器与 UTXO 缓存器的逻辑和实现应当类似，但两者作为各自独立的服务运行，因为验证节点的请求目标（币金或凭信）很明确。

当管理层最后打包区块（或验证其它组发布的区块）后，新交易的未花费/未转移输出项会发送到缓存器，缓存器及时更新自己。


#### 附：外部脚本引用缓存

交易中存在对外部脚本的引用（`GOTO`, `EMBED`, `SCRIPT`），为了高效检索，它们也应当被实现为一个缓存。

这是一个独立的缓存器（但可能与 UTXO/UTCO 缓存器同机运行），需要考虑及时清理和实时更新。


### 管理层

管理层里有两个角色：**广播**、**调度**。

不同校验组的管理层（广播者）之间相互连接，完成对区块整体的验证和广播。


#### 广播

- 如果接收到铸造候选者的铸造申请，执行相关交互流程。打包并发布区块。
- 如果本组没有铸造区块，接收其它校验组发布的区块、补足差异部分，验证并转播。

> **注：**
> 管理层通常自行负责少量差异部分交易的验证，以获得效率和安全。
> 打包区块时需要处理双花问题，通常遵循先到先得的原则（但也可能交易费高者优先）。


#### 调度

- 接收守卫者传入的准合法交易（通过首领校验），存入待验证交易池。
- 接收校验员的工作申请派发准合法交易，让它们执行完整的合法性验证，并根据情况评估和执行可能的扩展复核。
- 记录组内各成员的工作业绩，便于最终的酬劳分配。

> **注：**
> 在派发准合法交易给校验员时，会有适当冗余。
> 调度员会将当前合法的交易同步给广播者，以便它能及时打包或验证区块。


#### 连接关系

- **组内**：守卫者、校验员。
- **对外**：其它校验组的管理层（广播者）。


#### 附：交易收录的优先级

管理层遵循如下的优先级共约收录交易到区块。

有凭信提前销毁 > 币权销毁较多 > 交易费更多。


#### 附：不收录的交易

- 输入项 TxID 20字节内碰撞的交易（几乎不可能，但为了安全性仍然排除）。
- 进入 UTXO/UTCO 集的新交易，如果在末端叶子层时 TxID 前8字节碰撞（理由同上）。

这两项规则可以保证交易ID始终有效，提前防范安全性问题（几乎不可能发生）。


### 守卫者

负责交易的进入把关，是校验组*待验证*交易的来源。

守卫者与外部其它校验组的守卫者和校验员连接，接收它们的交易，执行首领校验，实现交易的全网快速广播。

守卫者也会管理一个黑名单，那些首领校验通过但最终非法的交易，其首领输入会被记录。


#### 连接关系

- **组内**：管理层。提交初步验证合法的交易。
- **对外**：=>守卫者、<=校验员。交易的进入把关和快速广播。

> **注：**
> 管理层会实时向守卫者同步已提交交易的ID，避免其它守卫者重复校验&提交。
> 不过这不影响守卫者对外（其它组守卫者）转播交易。


#### 附：关于快速广播

将接收的交易转播给其它组守卫者时，是否需要先完成首领校验？这可能是一个不易抉择的问题。

> - 不完成：非常有利于交易的快速广播至全网。但攻击者有机可乘。
> - 先完成：更安全，但明显不是快速广播的友好方式，特别是在交易量大时。

一个折衷的方案可能是 **随机抉择**：对于每笔入站交易，以一定概率（如 50%）先执行首领校验，通过后才转发；另一些交易则直接转发。

这样，可以一定程度抑制攻击的动机，同时也能保有相对较高的广播效率。


### 校验员

执行交易的完整校验工作。

校验员向管理层请求校验任务，执行完整验证并反馈结果。与其它组的守卫者建立连接并提供自己验证合法的交易。


#### 实现参考

校验员并不清楚管理层派发的验证是普通验证还是复核验证。这可以更好地预防可能的恶意行为。

对于需要太多计算量的交易，校验员可以拒绝并返回*负载过高*消息。管理层如果接到多个相同反馈，可能对交易进行冷处理。


#### 连接关系

- **组内**：管理层。申请校验任务并反馈。
- **对外**：=>守卫者。传递自己已验证合法的交易。


### 附：首领校验

对于接收到的交易，仅验证其首笔输入，合法即通过，这就是首领校验。

首领校验可以加快交易在网络上的传播，但攻击者可能构造大量首笔输入合法但后续非法的交易进行**洪流消耗**攻击。因此这里有一些规则：

- **约束**：首笔输入必须是币金，且为全部币金输入里币权最大者。
- **黑名单**：对于最终完整验证失败的交易，该首笔输入会进入黑名单，临时冻结。

这样可以限制攻击者的资源可用性，避免密集持续的攻击。黑名单的冻结时间可能为**24**小时。



## 安全保障

### 冗余校验

每一笔交易都会由多名校验员执行完整的验证。

对于同一笔交易，如果全都反馈为合法，则为合法。如果至少有一名判断为非法，则纳入扩展复核的范畴。

> **注：**
> 校验员的冗余度通常不低于2（同一笔交易至少2名提交），但这取决于校验组自己的决策。


### 扩展复核

对于存在合法性分歧的交易，管理层会将它们派发给另一些绩效更好的校验员。**注**：依然也会有冗余。

- **一级复核**：零报错，交易合法。超过半数报错，交易非法。低于半数，进入二级复核。
- **二级复核**：只要有报错，即视为非法。

复核判断为非法的交易并非就再也没有机会了。如果其它校验组验证合法且打包进入区块，当该区块同步到当前组时，该交易会被重新验证。


### 组间反馈

校验员可以直接对外（其它组守卫者）传递自己验证合法了的交易，这可以加速交易的传播。

如果守卫者接收的交易被本组验证为非法，也会即时反馈到其发送者（它组校验员），此时发送者（校验员）可以再次重新验证一次。这会大大强化验证的可靠性。

> **注：**
> 这要求管理层建立守卫者递送交易的记录，这样才能反馈到源头校验员。



## 铸造者

有权签署区块的节点只能是择优池成员，理论上由权重最高者（择优池冠军）执行。

铸造竞争是自由的，不论是管理层、守卫者还是校验员，它们都可以参与铸造预选（成为择优池成员）。

管理层并不清楚哪些节点拥有铸造资格（铸造预选与交易校验无关）。一位铸造者可能同时参与多个校验组工作，其签名哪个校验组的区块并不确定。而且逻辑上，他还可以同时签名多个区块……

这会带来混乱，因此有如下规则。


### 低收益原则

铸造者同时签署多个区块的原因可能是希望更多的收益。因此这里的规则是：

**对于同一铸造者签名，收益最低的区块有效**。

这样可以避免铸造者多签。同时，这还能避免校验组重新打包区块的可能（比如校验组又收到高交易费的交易），影响按时出块。


### 信息的分离

Coinbase交易由铸造者创建，有着固定的结构，比如不同的地址接受不同比例的分成。

管理层需要检查CoinBase交易是否符合要求，并将之合并到区块的交易集。然后返回交易集以及 UTXO/UTCO 指纹的最终校验根（`CheckRoot`），供铸造者签名。

下图展示了哈希校验树，以及和签名的关系：

<img src="images/hashcheck-1050.svg" width="1050" alt="哈希校验树结构" style="background-color:#333; padding:10px 30px; border-radius: 20px;" />

**图解：**
- 每一层节点都是一条哈希单元序列，可能为数组或链表。
- `Minter's sign` 为铸造者对校验树根 `CheckRoot` 的签名，CheckRoot 为区块头内的字段。
- 叶子节点为交易ID（前置3字节序号，用于某些功能）。
- 哈希长度采用较长的64字节（SHA-512），以增强抗量子安全性。

除了是管理层自己，铸造者不知道区块的全局性信息 `CheckRoot`，他只能相信管理层，不过他可以验证自己构建的 Coinbase 交易是否在其中。这是一种有意义的信息分离，相互牵制以达成必须的合作。

铸造流程大致如下：


#### 铸币申请

节点检查自己是否在择优池中，若是，向管理层提交择优证明，请求创建铸币交易（Coinbase）。

1. 管理层验证请求，向申请者提供区块的交易费、校验组收益地址、公共服务地址、铸币量、兑奖截留等必要信息。
2. 铸造者按规则构造Coinbase交易，向管理层提交。**注**：记住Coinbase的交易ID。
3. 管理层验证提交的Coinbase交易、打包区块。然后向申请者提供区块的哈希树校验路径信息（含TreeRoot和UTXO/UTCO指纹）。

> **注意：**
> 铸造者可能定义自己选择的公共服务受奖地址，如果管理层不接受，就不会再向申请者提供签名用相关信息。
> 因此如果铸造者要这样做，可能需要向多个校验组申请铸造，以增加被接受的可能。


#### 签署区块

铸造申请者接收到返回的相关数据后：

1. 验证自己创建的Coinbase交易是否在其中（通过哈希树路径信息验证）。
2. 签署区块消息（针对 CheckRoot），提交给管理层。
3. 管理层验证签名，构造区块头，对外发布区块。

> **注记：**
> 区块头由管理层创建，让管理层更多一些自主性（如版本控制）。


### 区块发布

考虑网络效率，区块的发布分三段逻辑：

1. 广播区块证明。提供最少的证明性数据：Coinbase交易、Coinbase哈希验证序列（关联哈希）、铸造者签名、区块头等。
2. 发布区块概要。包含区块的全部交易ID序列，可能有优化处理（见下）。
3. 同步交易数据。区块收录的全部交易的数据。各节点应当仅有少量的交易缺失，补足即可。


#### 同步优化

发布区块概要时，可以优化同步的逻辑，加速传播。

1. 每个交易ID仅截取前16字节，按顺序打包传递。假设区块有64k笔交易，数据量为：`64*16 = 1MB`。
2. 接收者对比交易ID片段，如果缺失则申请补充完整。**注**：若有重复（几乎不可能）则一并请求。
3. 计算校验树根，完成区块核验。


### 围观者参与

铸造者竞争与校验工作无关。
因此如果希望铸凭交易的规模足够庞大，充分竞争（提高安全性），应当有一种更为开放的机制。这就是**围观者**参与的逻辑：

*校验组允许不参与校验工作的节点也加入进来，成为区块铸造的候选者*。

这其实无法避免，因为只要围观者参与择优池的竞争流程，它们就可能成为铸造候选者。如果不能进入校验组，结果是荒唐的。


#### 可选信息

围观者可能成为铸造者从而创建 `Coinbase` 交易，如果铸造者刚刚上线，可能并不具备评估*公共受奖地址*的足够信息。因此管理层还会提供 `Coinbase` 中需要的公共服务受奖地址以及兑奖槽标记等。

但这应该只是一个参考，原则上铸造者可以不接受。这可以让公共服务的受奖者更宽泛。


#### 交易量约束

理论上，铸造者只要知道上一区块ID和当前 UTXO/UTCO 集指纹，就可以铸造一个只有 Coinbase 交易的空区块，而不需要校验组的协助。这称之为自私铸造，但逻辑上它是合法的。

为了避免这种情况，有如下规则：**如果候选区块的币权销毁量 `3` 倍于主区块，则候选区块胜出。**

也即，对主区块的自私铸造至少需要验证大约 `1/3` 的交易才行，否则候选区块就会胜出。

这对于围观者或单个的校验员并不现实。而如果主区块不是自私铸造，它与候选区块的交易量差异就不可能如此巨大。

> #### 名词解释
> - *主区块*：指由择优池中最优的铸造候选者所铸造的区块。
> - *候选区块*：指由择优池中排序次于最优铸造候选者所铸造的区块（冗余安全）。



## 附注

### 铸造者最低开销原则

无需参与校验工作的铸造者很可能是一名围观者，硬件性能不足，设计应当充分考虑这一点。

铸造者仅需完成如下工作：

1. 签名择优凭证 => 向管理层证明自己。
2. 构造合规的Coinbase交易 => 提交给管理层。
3. 确认Coinbase未被篡改，签署区块，提交给管理层。

> **注：**
> 区块签署者也称为*铸凭者*。一个组员铸凭者会有两份收益：铸造分成和工作报酬。


### 关于最优规模

校验组的规模并非越大越好。

单个区块收集的交易是有限的，如果按6分钟一个区块，每块64k笔交易计算，每秒约**182**笔交易负载，可能**50-60**个节点就足够了。

校验员对交易的认领是自由的，能力强的可以多处理一些，反之则量力而行，这是自适应的。


### 一些不足

- 铸造者需要把收益发送到管理层指定的地址，这需要信任。
- 如果管理层自己就是铸造者，没有办法禁止他们独自享有收益。这只能通过足够的竞争规模来淡化影响。



## 技术细节参考

### UTXO/UTCO 指纹

UTXO/UTCO 集是区块链所有未花费/未转移输出的集合，为方便节点初始载入时对当前 UTXO/UTCO 集进行验证，添加了 UTXO 和 UTCO 指纹的设计。

另外，UTXO/UTCO 指纹实际上与区块ID一起，构成了一种对区块链历史的多路耦合保护。


#### UTXO/UTCO 指纹结构图

<img src="images/utxohash-1180x700.svg" width="1180" alt="UTXO/UTCO指纹结构" style="background-color:#333; padding:20px; border-radius: 20px;" />

> **图解：**<br>
> 顶层分级的年度指交易时间戳对应的年度（UTC标准时间）。<br>
> 三级分层采用ID序列的 `[8,13,18]`（而不是 `[0,1,2]`）字节值，以获得更好的随机性保证（避免ID塑造爱好者影响）。<br>
> 末端叶子节点为交易ID与其输出项是否未花费/转移的标记位的组合：Hash512(TxID || FlagOutputs)。

```go
FlagOutputs: {
    Count int        // 标记位字节数
    FlagBytes []byte // 每位对应一个输出项，1表示未花费/未转移，0表示已无效
}
```

这其实是一个宽成员的哈希校验树，总共四层的分级可减少每次输出指引改变带来的重新计算量。顶层为年度，虽然是一个无限增长的序列，但粒度足够大，可以接受。

**UTCO** 与 **UTXO** 集采用相同的结构和计算方式。

> **提示：**
> 当前UTXO集可以通过UTXO指纹验证，而UTXO指纹可以通过区块头链来证实。UTCO同理。


#### 意义

UTXO/UTCO 指纹会对区块链末端产生合法性约束，实际上，它有些像全链交易历史的当前总结。

正因如此，一个刚刚上线的节点可以请求并不太多的数据量（区块头链、末端局部区块、以及当前UTXO/UTCO集合），就可以大致确定目标主链是否合法了。

这可以极大降低新节点进入的门槛，提升区块链系统的整体效率。

> **附注：**
> 对于无限延伸的区块头链，实际上还可以籍由年块链来缩小数据体积。


### 附：从 UTXO/UTCO 集检索输出项数据

UTXO/UTCO 集的叶子节点只是表达交易输出项的花费/转移状态，但也可以在该层级下创建对交易数据的检索子集。

因为对海量的交易数据进行了分层/分组隔离，所以到终端叶子节点层的交易数量会很少。

我们可以在末端用微型集合进行检索，比如用一个 `map[int64]Outputs` 来存储交易的可用输入集，其中 `int64` 是交易ID的前8字节，`Outputs` 则包含交易的可用输出项。

> **注：**
> 对交易数据本身的合法性验证由另外的过程完成，这里只提供已经合法的信息。

这就是所谓的*UTXO/UTCO缓存集*，它是一个与UTXO/UTCO指纹结构相同的分层集合，提供对交易输出项数据的快速检索服务。


### 附：UTXO 集指纹的链式约束

#### 当前区块与当前 UTXO 集

- **当前区块**：指当前正在验证交易数据，即将创建的区块。
- **当前UTXO集**：当前区块所依据的UTXO集合，它尚未减去当前区块所收录交易的花费。

当前UTXO集去掉当前区块收录的交易的花费，加上新交易的输出项和Coinbase铸币，即为下一个区块的当前UTXO集。

当前区块的UTXO指纹从*当前UTXO集*计算而来。因为无需考虑新交易的收录变化，所以计算时间充裕。并且这还附带创建了一种循环递进的链式约束。


#### UTXO 集的逆向推导和链式约束

当前UTXO集是上一个区块的UTXO结果集，根据上一个区块收录的交易，可以逆向推导出*上一区块*的*当前UTXO集*。

假设当前区块为101号，当前UTXO集即为第100号区块的UTXO结果集。

1. 当前UTXO集减去100号区块的新交易输出项和Coinbase铸币，加上100号区块的输入项，即为100号区块的当前UTXO集。
2. 计算这个集合的指纹，它应当与100号区块上的UTXO指纹相同。
3. 这样就验证了101号区块的当前UTXO集的合法性。

如果再用100号区块的当前UTXO集推导99号区块的当前UTXO集并验证……循环迭代，我们就可以从一个最新的UTXO集逆向验证区块链至任意历史位置。

这样，UTXO指纹实际上就和区块ID的链式绑定，从不同的侧面共同锁定了区块链的历史。


#### 关于 UTCO 集的类似逻辑

UTCO 集也可以执行类似的逆向验证，只是依循的是凭信转移的逻辑，包括转移计次的递减和输出项的变更规范等。此处省略不作赘述。


### 附：关于含序哈希校验树

哈希校验树的叶子节点可以包含前置的序号，这可以提供某些特别的能力，比如随机抽检和某种模糊匹配。

这主要用于附件分片的哈希树校验树（计算片组哈希），以及区块内交易的自由定位（提取和验证）的场景。

另外也可用于优化交易数据的节点间同步：未知交易ID，但确知缺失的位置信息。



--------------------------------------------------------------------------

上一篇：[附.交易](附.交易.md)
