# Blockchain Core 核心实现

> **主旨**：极致简化，专注核心。方便任意场景下的自由集成。

## 需求

Blockchain Core 是区块链系统的核心组件，主要着眼于区块链整体的管理与维护。

核心应当精简并独立运行，可以与任意其它功能的部件协作，共同完成区块链生态的自由构建……比如被集成进普通用户使用的轻客户端、简单参与铸造竞争的围观者、正式参与交易校验的校验组各成员、公共服务器、浏览器插件、移动应用等等。

因为这种极简，共识构造也应当被剥离出来（只有校验节点才需要）。作为普通的用户轻客户端，公共服务的第三方节点等，它们只是区块链的用户，会默认区块链是安全的。


## 区块头

区块的ID由区块头计算而来，连续的区块头就形成了区块头链。

区块头结构（伪代码）示意：

```go
BlockHeader: {
    Version   int       // 版本号
    PrevBlock [64]byte  // 前一区块哈希
    CheckRoot [64]byte  // 校验根（由交易哈希树根、UTXO/UTCO指纹合并计算）
    Stakes    int       // 币权销毁（币天）
    Height    int       // 区块高度，代替时间戳信息
    YearBlock [64]byte  // 前一年块哈希（height % 87661 == 0 时）
}
```

**其中：**
- 币权销毁可表达交易量，会作为区块选择的一个因子（安全辅助因素）。
- 年块指从创始区块开始，每年引用一次上一个年块（按87661/年）。可用于更高效和节省地引用主链。
- 没有时间戳字段，时间戳通过高度和时间间隔计算出来（创始区块时间戳已知）。

如果整数按4字节计算，区块头长140字节（年块除外），区块头年数据量：140x87661 ~= **11.7**MB。

> **币权：**
> 未花费输出项金额和历史天数的乘积，一旦花费（销毁）则币权归零。


## 功能

### 入块验证

接受外部组件的区块提交，简单验证区块的合法性即可。
如果有相同高度的区块二次提交，简单反馈冲突错误（拒绝入块），外部需删除该区块后才能重新提交入链。

> **注：**
> 简单验证即可，比如新区块头的前一区块哈希值是否正确。
> 区块本身的合法性并不由核心负责，而是由功能剥离的外部提交者负责。


### 数据存储

根据用户配置，存储区块头链数据。区块头链需从创世块开始维持连续性，直至当前最新区块不可中断。

因为区块头支持年块哈希，所以实际上并不需要存储完整的区块头数据，只要年块哈希衔接，就可以维持链的连续性。用户可以配置任意年度的区块头数据忽略，只需维持年块的衔接即可。


### 数据完整性

由于核心不存储完整的区块头数据（年块衔接机制下的省略），但同时却提供完整的区块头链检索。因此需要一个确保完整性的机制：就是可以连接到第三方公共服务（`Blockqs`），以即时获取完整的区块头数据。

可能需要从多个第三方服务节点获取数据，以确保数据的可用性与完整性。


### 数据访问

- 提供区块头数据的访问接口，支持按区块高度、区块哈希值查询区块头。
- 支持区块头链的同步接口，方便外部组件调用进行区块头链的同步。
- 支持按年度查询区块头数据，方便快速定位特定年份的区块头。
- ……（待定）


### 手动切换主链

如果全球网络出现了分区超过2.5小时，25个区块的分叉竞争就结束了。此时两条链都是合法的，客户端应当允许用户手动选择自己认可的主链。

这可能很简单：只需要用户手动选择目标分叉的几个主要节点，然后请求分叉之后的区块头链数据即可。

> **附注：**
> 人工切换主链类似于用脚投票，这不是算法的逻辑，而是社会性的竞争与选择。
> 这在未来天基互联网强连接的环境下，应当很难发生。
