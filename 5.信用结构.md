# 信用结构

交易是信用表达和转移的一个封装，主要包含输入和输出两个部分。输入为信用的来源，由另一笔交易的输出定义，输出为信用的内容和受体。

输出内容里有一个锁定脚本。如果要使用该输出，用户需要提供该脚本的解锁数据。

> **注：**
> 下文中的代码仅借用Go语言代码的友好显示。


## 三种基本信元

本设计中，信用由三个概念表达：**币金**、**凭信**、**存证**。它们统称为「信元」。

1. **币金**：可拆分的数值，类似货币。也称为代币。
2. **凭信**：不可拆分的数据，可以是文本或二进制私有格式。表达契约、债券或数字凭证的逻辑。可转移。
3. **存证**：一种存在性表达。不可拆分，也不可转移。

如果一笔交易里全是币金，就是一笔纯粹的转账交易。如果还包含有凭信或存证，则是一笔混合交易。

仅仅包含凭信或存证的交易逻辑上没有问题，但交易上链需要交易费，因此币金输入是不可避免的。


### 币金

表达具体的价值额度，如货币或金钱，有时也被称为代币。

币金可以分割、合并或算术运算，其原始创建（无中生有）由区块的铸造者完成，即铸币。


#### 接收者

接收币金的主体，有时也称为区块链账号。

如果脚本采用系统内置的验证，接收者需要是标准格式地址，这由固定的规则构造而来：

- **单签名** 的公钥哈希地址。
- **多签名** 的复合哈希地址（见后详述）。

> **注：**
> 出于隐私保护，两种地址在外观上没有区别。

用户也可以在脚本中自行设计验证逻辑（不使用 `SYS_CHKPASS`），此时接收者可为空或任意48字节。


#### 金额

一个变长整数值，表达币金的数量，最小币金单位 `chx`（同 `Satoshi` 聪）。


#### 附言

支持简短的附言表达对转账的描述，最多 `255` 字节，可选。


#### 锁定脚本

控制当前输出对应的币金。如果用户提供的解锁脚本正确，则该输出可以被花费。

> **说明：**
> 锁定脚本其实表达了交易构造者对未来花费者的约束。
> 脚本可以很灵活，因此约束功能会很丰富。下面凭信和存证的脚本同样如此。

未花费的币金存放在 **UTXO**（Unspent Transaction Output）集中。


### 凭信

表达一种信用和凭证，可以转让。文本或二进制数据，不可拆分，但转移时可能允许修订。

凭信的转移类似于币金的**花费**逻辑，未转移的凭信存放在 **UTCO**（UnTransferred Credit Output）集中。

任何人都可以创建凭信，就像普通的交易一样。


#### 接收者

与币金的接收者逻辑相同，通常为一个可验证的目标。


#### 创建者

凭信的创建者（<256字节）或创建者引用。

创建者**引用**可方便地追溯最初的创建者，这也是检索初始凭信本身的依据。


#### 配置

包含2字节的配置。

```go
15] 新建标记。初始的凭空创建。
14] 可否修改。允许下家修订描述。注：创建者、标题和附件ID不可变。
13] 是否修改。如果输入源可修改且当前已修改，置位。
12] （未用）
11] 转移计次。表示后面跟随转移次数值区，2字节长。
10] 高度截止。表示后面跟随有效期截止高度，变长整数。
[10] 低10位定义描述内容长度（<1k）。
```

转移次数和有效期可同时存在，以先到为准。

转移次数需在每次转移时递减，截止高度则不可变。在有效高度内，如果当前转移次数已降至0（输入为1，输出为0），则该笔输出不再进入 UTCO 集。


#### 标题

凭信的标题，通常应当是人类可阅读的文本（<256字节）。


#### 描述

凭信的简要描述，通常可阅读。最长支持到 `1k` 字节量。


#### 附件ID（可选）

凭信支持附件，不限制大小。

附件将由数据网络存储和提供检索，交易中只包含一个附件ID（<256字节，包含结构）。这是对区块链空间局限的解耦。

> **注：**
> 理论上，币金输出也可以包含附件ID，但暂不支持。


#### 锁定脚本

限制凭信转移的一段代码。与币金相似，用户转移时需提供正确的解锁脚本。


#### 附：实现参考

对于高度截止的检查，可能需要创建一个 `高度=>[Index]` 的索引集，精简引用有该配置的凭信输出。当抵达某个高度时，快速检索并标记或清理移除。

该集合应当可从公共服务器（Blockqs）获取，但也可以同步了 UTCO 集后，自己执行全量扫描（一次性）。新的区块加入时，只需扫描补充即可，时间可以很充裕。


#### 附：限制

- **高度截止**：不能超过*100年*（相对高度差）。
- **活跃保证**：无期限凭信至少*11年*激活一次（可转给自己），否则失效。此为协议，强制执行以维护UTCO指纹的一致性。
- **转移计次**：由固定的2字节容量自然限定（<65536），依然受11年活跃保证约束。

这些限制是为了约束UTCO集的规模，避免滥用或攻击（无限增长）。凭信的活跃应当是常态。

> **注记：**
> 因为有交易费的成本，100年的高度截止不受11年活跃度的约束。


### 存证

表达一种存在性。可引用但不可转移，任何人都可创建。

存证用途可能很多，如原始版权声明、证书存储（供公开检索）、子链存根、话题索引……或作为第三方应用的起始凭证等。

> **注：**
> 存证不可转移，无输入项内存快速检索需求，因此没有限制。


#### 创建者

存证的创建者（<256字节），可以为空。


#### 标题

存证的标题（<256字节）。表达存证是什么，通常人类可读。


#### 内容

存证的具体内容，通常为文本格式。由前置的 `2` 字节指定内容长度。

```go
 15] （未定义）
 14] （未定义）
 13] （未定义）
 12] （未定义）
[12] 低12位记录内容长度（字节数），最大支持到4KB。
```

#### 附件ID（可选）

复杂的存证通常需要附件增强说明。与凭信相同，附件数据存储于外部数据网络。


#### 识别脚本

用于程序化识别和处理。

因为存证不可转移，所以不能作为新交易的输入项。但可以成为输出脚本逻辑的一员，供第三方客户端识别和使用。



## 关于凭信

### 创建

即初次创建，没有输入项，任何人都可以凭空创建。

创建时决定凭信是否可修改，并置位新建标记。如果可修改，置位相关标记。


### 转移

将凭信的属主转移为新的接收者。

如果凭信可修改，则转移时可根据规则做出修订（改变描述），并置位*是否修改*标记位。否则只能改变接收者和锁定脚本。

在转移时也可以改变可修改性：由可修改变为不可修改。**注意**：这是单向的，不能由不可修改变为可修改。


### 合规性

根据凭信的可修改性以及是否修改标记，检查凭信的转移是否合规。

- **不可修改**：只有接收者和锁定脚本可变，创建者为一个引用。
- **可修改**：只有描述可以改变，且*是否修改*标记位应当置位。


## 关于附件

### 附件ID的结构

```go
(1)     ID总长：1字节（<256）。
(1+1)   附件类型：由2个字节表达，前一字节为大类，后一字节为小类。
(1)     附件指纹强度：按4字节增量：0=>16, 1=>20, 2=>24, ... 12=>64。
(16+)   附件指纹。附件数据的哈希，算法 `BLAKE3`，长度由用户自己决定（最低 128 bit）。
(2)     分片数量：2字节表达（<65536）。
(48)    片组哈希。按二元结合计算的哈希树根（类默克尔树），叶子节点含前置2字节序号。
(~)     附件大小：变长整数，单位：字节。
```

> **注：**
> 附件指纹是对数据本身的完整哈希，不分片。
> 片组哈希用于分片验算，与附件指纹的逻辑不同。双哈希可强化附件安全性。
> 参考：
> 若每分片最大 `2MB`，则64k个分片可表达 `128GB` 数据。


#### 规则：

- 分片数量为 `0` 时，表示无分片，后续片组哈希字段位取消。
- 分片数量为 `1` 时，与无分片相同，但此时片组哈希是相应算法的附件数据哈希。
- 分片数量为 `>1` 时，表示有分片，片组哈希由正常的含序哈希校验树计算而来。
- 哈希树的叶子节点为各分片数据的哈希（48字节），另外前置2字节序号，共50字节。
- 附件类型参考 HTML:MIME 文档类型分类……

> **注：**
> 叶子节点前置2字节顺序号方便随机检索和验证。


### 附件的分片验证

如果需要附件数据的局部分片，可以通过序号简单获取和验证。

1. 向源节点发送附件的分片哈希和序号，请求分片数据。
2. 源节点提供分片数据和验证该数据的关联路径哈希。
3. 用户得到数据后：计算分片数据的哈希，前置序号，结合路径哈希计算并验证片组哈希（是否相同）。

> **要点：**
> 在分片数据的哈希前置序号由验证者实施，源节点无法作弊。


### 附件的大小

原则上，附件不限制大小，但它可能影响交易费：附件越大，费用可能越高。

区块链节点很难核查附件大小的真实性，因此本设计也不支持此能力。用户可以任意设置附件大小字段，但如果这信息不实，可能影响它被认真存储的机会，因为它可能被视为不良行为或数据已损坏。

大附件通过P2P应用分享传输，片组哈希可能会被复用，但应用节点之间的分片传输策略是自由的。

> **数据价值：**
> 如果附件是开放版权的公共文档，数据本身的价值可能会让数据网络更乐意持有。



--------------------------------------------------------------------------

上一篇：[激励机制](4.激励机制.md)<br>
下一篇：[脚本系统](6.脚本系统.md)<br>
