## 概念集

### 基本概念

#### 理想块

按交易时间戳计算的应当及时收录该笔交易的区块，称为交易的理想块。
如果按6分钟的固定出块时间计算：`理想块高度 = （交易时间戳 - 创始块时间戳） / 6分钟 + 1`。

按理想块定位交易可以不受实际收录区块的影响，UTXO集就是这样对交易进行分级管理的，便于快速定位。
区块查询公共服务（blockqs）也应遵循同样的规则，这可以解耦交易与实际打包的区块。

> **注记：**<br>
> 区块查询服务器中包含有实际区块，可以判断哪些交易已经被确认。<br>
> 真实区块里的交易索引包含有交易时间戳，因此可以快速定位到按理想块布局的交易数据存储。<br>


#### 末端区块

末端区块有两个指示场景：

1. 区块链当前最高高度处的区块，即当前最新已确认区块。
2. 交易时间戳对应区块链上最早可收录该笔交易的区块（理想块）的前一个区块。

前者是与当前实际的时间对应，后者则与交易的时间戳对应（称为交易的末端区块）。


#### 当前区块

当前正在验证交易，需要打包到一个新的区块，该即将创建但尚未创建的区块称为当前区块。它是区块链末端区块的下一个区块。


#### 铸凭交易

根据规则，有资格参与铸造竞争的历史交易就称为铸凭交易，意即 **铸造依凭的交易**。


#### 哈希相似性

如果将两条哈希序列描绘成两条曲线，两条曲线的相似度称为哈希相似性。衡量这种相似性的算法可以有多种，本设计中采用4字节整数切分计算相位差和（相同位置整数值差的绝对值之和）来表达。


#### 币权销毁

一笔交易的全部输入所蕴含的币权（币量x币龄）之和，即是交易所销毁的币权。因为币龄被重置为零，所以这是一种销毁逻辑。


#### 铸造委托

交易的构造者可以在交易头中指定一个铸造地址，当交易充当铸凭交易时，节点会验证对区块的签名是否为该铸造者。这是一种外部委托机制，提供冷挖矿或委托专业者铸造区块的能力。


#### 历史标记

交易的构造者需要在交易头中设置一个适当长度的序列，该序列是主链-11号历史区块的哈希值的一部分（前段）。这可以实现交易对主链的绑定，为分叉发现和分叉竞争提供辩识依据。序列长度可能是20字节，应当足够长以抵挡当前哈希矿机的算力。


#### 哈希塑造

因为铸造竞争是评比哈希相似性，假设攻击者有足够强大的哈希算力，则可能塑造交易或区块的哈希摘要，以争取更好的哈希值来提升自己的竞争力。

交易ID由用户构建，因此可以被任意塑造，区块的哈希则只能由铸造者塑造。因为铸凭哈希的算法约束，区块哈希塑造只能针对某单一交易（而非一组交易）。


#### 择优凭证

铸造候选的铸凭交易在一定时间内会被收集和筛选，最终形成一个32名候选者的择优池。作为一种安全性设计，择优池中的前2名候选者的权重值（哈希相似性对比的相位差和）会被存放在区块头内，其权重证明也需要保存在Coinbase交易中。这证明了铸造者的优质性，故名之择优凭证。


#### 分叉合并

如果分叉真的发生了，当主链竞争结束后，非主链的那条支链上的交易可以被主链上的新区块合并。这是一个重要的友好性措施，它可以避免用户在分叉阶段选择绑定主链的艰难，甚至影响系统的可用性。


#### 未来交易

在交易的传播过程中，相对于节点的当前实际时间，如果交易的时间戳属于未来，它就是一笔 **未来交易**。这种相对性还可以针对区块的出块时间，如果交易的时间戳处于区块的出块时间点以及之后，它就是一笔相对于该区块的未来交易。

未来的交易不能被区块收录，这是一个基本设计。游离于区块之外的未来交易需要等待真实的时间到达之后，才能被收录。


#### 错时交易

对于一个节点来说，如果一笔交易的时间戳相对于真实时间太晚，它们就被视为错时交易（错过了正确的时间）。这个概念被用于 **错时延迟** 设计，它可以避免铸造者对错时交易的贪婪等待，以保证区块的按时打包广播。


#### 错时延迟

**当出块时间到达后，节点停止时间戳在出块时间之前的错时交易的转播，直到区块被创建、广播并确定下来。之后再恢复这些交易的传输**。这是一个端点约定，当出块时间到达后，如果可以被打包的交易已经被明确规定暂停广播，铸造者就没有理由再等待了。

错时延迟不会影响该区块下一区块时段内的交易的正常转播，即不会影响当前区块的正常工作。当措施延迟所约束的区块最终确定后，那些被暂时阻挡的错时交易会恢复传播，因此当前区块依然可以收集到它们（**注**：前一区块的确认不会拖延到当前区块结束时）。


#### 时序保障

明确双花的交易可能是一种纠正行为，但这种纠正需要在一个时间限度内。如果两笔双花交易的发布时间相差较大，它们会被视为攻击而被节点丢弃。

对于一个中转节点来说，接收到交易验证合法后会存储到内存池中，同时也需要记录交易的实际收到时间。如果发现新收到的交易是一笔双花交易，它们根据下面的规则行事。

1. 如果新交易的时间戳更晚（值更大），则忽略丢弃。因为区块应当收录更早的交易。
2. 如果新交易的时间戳更早（值更小），则检查时间戳与当前实际时间的误差：1分钟内视为更正交易正常转播，否则视为双花攻击丢弃。
3. 如果新交易的时间戳与原交易相同，则检查原交易的实际收录时间，如果在1分钟之内，也视为正常的更正交易转播，否则视为双花攻击丢弃。

这是一个零确认安全机制的辅助措施，与适时转播一起工作。


#### 最低交易费

用户构造的交易中必须包含一定额度以上的交易费，这个额度就是最低交易费。它由前期的平均交易费自动计算而来：

**系统每 `24000个` 区块（100天）统计一次，取平均值的 `1/5` 作为当前阶段的最低交易费。**

最低交易费只是作为一个端点约定（而不是协议）来运行，节点不会转播交易费低于这一额度的交易。

这可以对 **大量的微尘交易** 攻击有一定的防护效果，同时它也是零确认安全的辅助性措施之一，避免交易不被及时收录以至于过期带来的零确认失效问题。


#### 交易过期

未被收录的交易超过一定时间后会作废，这个期限可能是 `480个` 区块（2天）。这是按交易的时间戳和当前时间对比判断的。它的意义在于：

1. 缩减未确认交易的规模。
2. 提升时间因子的价值，为某些应用提供条件。

人们不应当期待一笔超过2天都未完成（确认）的交易依然有效，相反，它可能带来一种漫长期待的心理负面情绪。


#### 节点评估

**基本原则**

- 违反强制合法性规则（协议）的节点会被加入黑名单并断开连接。
- 违反宽松约定的节点会被容忍，虽然保持连接但其违约会被中断（类似于分布式阻断）。


#### 开放式存储

区块数据和交易里的附件被公共服务网络存储，这分离了区块链的负载。公共服务网络的数据存储是P2P模式的，服务器通过 **数据紧缺性感知** 来获知数据是否需要补充冗余存储。这是一种开放的架构，并且十分简单。

开放式存储可能带来隐私性问题，这可以通过加密来缓解，但更重要的是：你不应当把重要的隐私性数据存放在公网上。


-------------------------------------------------------------------------------


### 交易相关

#### 交易ID

交易头的哈希摘要，可能由两种不同的哈希算法嵌套计算而来。`32字节`。


#### 交易索引

在实际区块中表达交易存在性的索引，由32字节的交易ID后附加8字节的时间戳构成。`40字节`。
时间戳附加在ID之后，使得不会影响交易索引的「按分段」排序的规则。同时，时间戳可以提供「理想块」的高度计算。


#### 交易定位

理论上，对目标交易的引用仅需交易ID即可，ID拥有可靠的唯一性。但在现实使用中，单纯的交易ID并不容易构建出一个结构良好的存储引用系统。
本设计中采用理想块高度对交易进行「年/日/块/」三级基础定位，然后再用交易ID的前8字节进行255分段，构造出一个友好的引用结构。

因此对交易的检索需要包含：理想块高度（4字节）和交易ID（32字节）。如果需要定位交易内的输出项，则再包含一个2字节的输出项下标。


#### 输出指引

UTXO集内对交易中输出项的使用状态标记，可判断输出项是否未花费。每一项占用一个标志位，一笔交易中最多支持64k项输出，因此标记位最多占用：`65536/8 = 8192字节`。

每一笔交易的输出指引计算哈希摘要后，作为该笔交易的使用状态指纹，用于汇总计算UTXO指纹。


#### 交易消息

在网络上广播的完整交易数据称为交易消息，包含：

1. 交易ID + 签名数据集校验码。`32+8` 字节。
2. 交易头数据 + 交易体数据 + 输入源的签名数据集。


-------------------------------------------------------------------------------


### 其它

#### 四元链哈希树

模拟默克尔树（Merkle），但每一层级为链表结构，上层的每一个节点指向下层链段的首个节点。
父节点哈希值 = Hash256（4个子节点哈希值串联）。

图示：

<img src="images/list4th-1050x700.png" width="1050" alt="四元链哈希树" />

说明：
- `Tx.0, Tx.1...` 为后置8字节时间戳的交易ID，有序排列。
- `H1,0，H1,2...` 为下级子链段4个成员合并计算的哈希摘要。
- 每一层节点都可以形成一条贯穿的链表，能够直接获取某层级的成员，甚至跨层提取。
- `Coinbase sign` 为铸造者对哈希树根（Root）和 `UTXO指纹` 的签名数据，共同参与 `CheckRoot` 计算。


#### 组队校验

不同的节点可以组队一起校验交易，通过恰当的分工管理和冗余复核设计，让离散的节点协作完成一个区块全部交易的校验工作，称为组队校验。交易天生拥有独立的逻辑，一笔交易就是一些信用完整转移的过程，因此按交易为单位的分工协作是可能的。

这可以视为一种**纵向分片**的负载分离模型，让区块链的工作能力大幅提升，而且这种模式下计算力的扩展也很灵活。


#### 首领输入与首领校验

为了支持交易尽快地在网络上传播，便于全网更有效率的处理交易，端点对于接收到的交易，仅验证其首笔输入是否合法。该首笔输入即称为首领输入（Leader TX）。仅验证首领输入的行为称为首领校验。

为了避免攻击者构造大量首领输入合法但后续输入非法的交易实施洪流攻击，这里有一个简单的约束和一个黑名单抑制措施：

- **约束**：首领输入必须是全部输入里币权最大者。
- **抑制**：完整校验失败的首领输入会进入黑名单。

考虑容忍偶尔的失误，进入黑名单并不是永久的，这个期限可能在3天以上。如果这是一个失误，或者攻击者想要花掉这笔输入，他们要么等待有效期过后，要么可以将之编入一笔有更高币权首领输入的交易里。这是允许的。



-------------------------------------------------------------------------------

下一篇：[附2：攻击与安全](附2.攻击与安全.md)<br>
下一篇：[用例参考：examples/*.md](examples/)<br>
