//////////////////////////////////////////////////////////////////////////////
Copyright (c) 2019 - 2025 @cxio/blockchain

    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.3
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


区块链是区块的集合，区块包含了当前合法并可纳入区块的不定数量的交易。如果有一笔交易被纳入了区块，就相当于该交易被记账了。

区块可以被任意的节点构造出来，其它节点验证其中的交易，如果完全合法，理论上这一区块就可以成为区块链上的新区块。但正因为任意节点都可以创建区块，所以就需要一种机制来决定：谁的区块可以进入主链，也即：谁拥有区块的铸造权。


## 基于历史的证明（PoH: Proof of Historical）

交易ID是交易数据的哈希摘要，拥有随机性，因此我们可以把交易ID用作某种评选因子，评选出哪一位用户可以铸造区块。

交易是任何一位使用区块链的用户都会创建的，拥有普适性，同时，它也是一种历史性数据无法更改，所以十分适合铸造评选的用途。

与传统的PoS权益证明不同，交易ID与交易上的财富无关，不论交易中携带了多少金额，ID都是平等的，没有富者越富的逻辑。唯一增加获选机会的方式是创建更多的交易，但这可能并不是一件真实有效益的事，因为每一笔交易都需要支付手续费。

另外，这种机制会一定程度鼓励交易，而更多的交易和交易费能更好地保证矿工的收益，这是一种良性回馈的逻辑。


### 规则

- 提取历史交易信息和目标区块的信息，通过某种安全性构造，计算两者的**相似性**。相似程度越高，则权重越高。
- 目标区块取区块链末端 `-9号` 区块。这是一种动态的逻辑，随着新区块的不断生成，实际的目标区块也在不断改变。
- 参与评选的交易应当有一个范围，这里设计为 `[-9 ~ -100,000]` 的范围（含边界，约一年半）。

设定一个范围使得存在结束点。这是一种淘汰机制：旧的交易被排除，新的交易不断进入，攻击者总是需要不断积累新的资源……

为便于描述，有资格参与铸造评选的交易称为「铸凭交易」，以铸凭交易为基础演算的哈希称为「铸凭哈希」，作为评比参考的 `-9号` 区块称为「评参区块」。

> **注：**
> 铸凭交易的铸造者是该交易的首笔输入源的接收者（即花费该输出的账户，仅限币金）。


### 哈希相似性

如果将哈希字节序列想象成一条以字节值为纵轴（Y轴），字节序位为横轴（X轴）的曲线，两条曲线的相似度即称之为哈希相似性（*本设计中的定义*）。


#### 哈希塑造

对比两条哈希序列的相似性，可能出现一种攻击：*通过向哈希源数据中加入随机无用的数据，可以塑造哈希，使其趋近于某种想要的结果*。

为避免或缓解该攻击，需要设计巧妙的安全机制。


#### 可塑性安全

参与铸凭哈希演算需要一些简单的因子，下面是一些候选：

- 交易ID：**强塑造**。用户可以通过添加随机数据任意改变结果ID。但如果已成历史信息，则无塑造。
- 区块ID：**强塑造**。铸造者可以通过Coinbase交易或构造普通交易，塑造区块ID。
- 择优权重：**无塑造**。即铸凭哈希的权重，为特定算法的结果，源数据确定，无法改变。
- UTXO指纹：**弱塑造**。只能通过增减交易来塑造，影响交易费收益。铸造者也可以花费自己的代币来塑造，但依然有交易费问题。
- 币权销毁：**弱塑造**。交易的币权是确定的，铸造者只能通过增减交易本身来塑造总值。

塑造的逻辑：

- 强塑造因子 + 强塑造因子 => 强塑造。
- 强塑造因子 + 弱塑造因子 => 强塑造。
- 弱塑造因子 + 弱塑造因子 ≠> 强塑造。

因此前面的历史区块范围排除了评参区块之后的部分（`[-1 ~ -8]`），因为这部分交易对于评参区块来说是未来而不是历史。

随着时间的流动，每一个区块都会变成评参区块，为避免铸造者对区块进行塑造以适配自己的历史交易，我们需要约束铸凭哈希演算的结构。


#### 铸凭哈希

铸凭哈希演算需要加入评参区块的信息，这样才能构建动态的结果，但该信息应该是弱塑造因子，所以评参区块的ID是不能选用的。

这里，我们选取评参区块里的*UTXO指纹*。

另外，如果引用某种在评参区块创建时无法预知的信息，则可能效果更好。在下面的算法示意中，该信息称为**X信息**，是从评参区块的下一个区块中提取的。

最后，铸凭哈希应当用签名之后的数据进行计算，这样可以隐藏交易ID本身，避免攻击者寻找和收集那些潜在的高权重者。

> **说明：**
> 下面的伪代码类似Go语言语法，仅用于表意。

铸凭哈希算法：（示意）

```go
// 签名源数据
// 这是公开的信息，攻击者也可以探查。
// 安全性：
// 增加评参区块信息可获得一种交叉关联。
// X信息源于后继块，当前未知，铸造者无法通过塑造来有利于自己的铸凭交易。
var hashData []byte = Hash256( 铸凭交易ID + X信息 + 评参区块:UTXO指纹 )

// 铸造者签名
// 结果是私有的，攻击者没有私钥无法得知该数据。
var signData []byte = Sign( hashData )

// 铸凭哈希（64字节）
// 攻击者无法走到这一步，因此也无法判断谁是高权重者。
var hashMint []byte = Hash512( signData )
```

<!--
原用“评参区块ID”时，可有以下攻击方式：

因为X信息为后继块币权销毁值，虽然未知，但攻击者可以预期假设一个值。
然后依该值进行区块的哈希塑造。

如果攻击者是拥有大量交易的铸造优势者，它很可能成为后继块的铸造者。
于是，当它铸造后继块时，它调整交易集以使得币权销毁值符合前面预设的那个值……

虽然很难，但也可能成功。
而一旦成功，前面通过强塑造得到的竞争优势，几乎是必胜的。

修改为UTXO指纹后，作弊的就是前一个区块的铸造者，逻辑相似，但此时它需要塑造UTXO指纹，这很难。
但即便假设后继后继块的币权销毁为某个值，塑造的效果也会大打折扣。
而且也同样需要后面区块的合谋，调整币权销毁值相等才行。
这代价有点很大。

这就是上面「弱塑造因子 + 弱塑造因子 ≠> 强塑造」的情形。
-->


#### 基准哈希

由评参区块信息衍生计算而来的哈希，用于与用户的铸凭哈希进行相似性对比。

```go
// 加入铸凭哈希获得关联性牵制。
var mintBase []byte = Hash512( hashMint + 评参区块:UTXO指纹+择优权重 )
```

这里还加入了评参区块中的择优权重值参与计算，理论上它可以再增强一些安全性。分析如下：

相对于评参区块，塑造攻击可能性有：

- **前一区块**：当前UTXO指纹的构造者，**可**塑造攻击。但UTXO指纹为弱塑造因子，且需配合后后块币权销毁值。
- **评参区块**：当前择优权重确定，无动态可变因子，**无**塑造能力。
- **后一区块**：币权销毁值可调，**可**塑造攻击。但币权销毁值为弱塑造因子，且需配合前前区块塑造。

一种可能有效的攻击：

- **前一区块**：铸造者先假定后后区块的币权销毁值为某个固定的值，且评参区块由择优池第一名铸造（权重在择优池中已知）。然后改变UTXO指纹，塑造哈希。
- **评参区块**：占位。无攻击能力。需保证择优池第一名正常在线签名，否则攻击无效。
- **后一区块**：前前区块的合谋者，配合其设定的币权销毁值，调整交易集匹配该值。若成功相等，则前前区块塑造成功。

攻击代价：

1. 攻击者首先需要后后区块的合谋。如果攻击者是一个拥有大量交易的铸造优势者，后后块可能就是自己铸造。有一定难度，但有机会。
2. 变化UTXO指纹需要大量交易取舍，或者花费攻击者自己的代币。交易费明确有损失，不论是自己付出还是少收取别人的。
3. 因为基准哈希使用了评参区块铸造者的权重，所以如果该值变化（如冠军掉线由亚军替换），则塑造无用，功亏一篑。当然这应该很少出现（但不为零）。
4. 假设一个预期的币权销毁值然后由合谋者调整匹配，这样更有效益，但调整币权销毁总值依然不自由，同样也有交易费损失问题（本来可以都要的）。


#### 关于X信息

X信息是后继区块的**币权销毁**总值，它存储于其区块头内。

理想情况下，后继块的*择优权重*是随机并确定性的，它由众多竞争者动态产生，拥有不可预测性，逻辑上未知。但遗憾的是，它实际上已经在择优池中了。

交易的币权不是任意数，一个区块的币权销毁总值只能通过增减交易来改变，这是一个弱塑造因子。

考虑增强哈希数据源的变化范围，可能附加区块的**时间戳**信息（固定8分钟增长）。


#### 附：哈希相似性算法

在哈希序列中按4字节为单位取点（X轴）计算点位的值（Y轴），得出一条曲线，两条曲线各点在Y轴上的差值称为**相位差**，各相位差的绝对值之和即为总的**相似性**。相位差越小，表示两条曲线越相似。

```go
// X轴：按4字节分段取点
// Y轴：上面4字节转为整数值
var sum int64
for n:=0; n<16; n++ {
    i := n * 4
    v0 := Uint32( mintBase[i : i+4] )
    v1 := Uint32( hashMint[i : i+4] )
    sum += | v1-v0 |
}
return sum / 16 // 取平均，保证4字节不溢出
```

返回的平均相位差即用于铸造评选，值小者胜出。


### 最终唯一性

理论上，不同的竞争者可能出现*相位差*相等的情形，此时就需要最终唯一性来决定胜负。

这里简单地取基准哈希本身来对比（算法包含了铸凭哈希的影响），值小者胜出。


### 设计参数

> 铸凭交易的有效范围：`[-9 ~ -100,000]号` 区块，含边界区块本身。
> 哈希相似性对比取 `512位` 哈希长度（64字节），X轴点位值取 `32位` 长度（4字节）。
> 最终唯一性保证采用基准哈希本身（`mintBase`）逐字节对比，值小者胜出。



## 铸造者

用交易ID作铸造评选因子拥有普适性，候选基数庞大，从尽可能大的规模中择优，才能更好地压制潜在的攻击者。

让普通的用户也尽可能地参与铸造是一项社会性工程，但从技术上促进此事也是一个良好的设计。组队校验的普遍小中心方案实际上是友好的，它兼顾了中心化的效率和专业，同时也具有随机的大众性（自由组队很容易）。

铸造者由交易的输入项承担，即输入来源的账户拥有铸造权。一笔交易可能有多个输入项，因此实际上一笔交易可以衍生出多个铸造竞争项：哈希源（`hashData`）由不同的账户签名而得到不同的数据。


### 交易头

类似于区块头抽象了区块数据，这里设计了交易头结构。

交易中的输入和输出部分会分别计算哈希，然后两者合并计算的哈希即为交易体数据的哈希，交易头的哈希即为**交易ID**。

```go
// 交易ID：
// 长度参与哈希计算，增强嵌入式约束。
Hash(输入段长度:输入段哈希 + 输出段长度:输出段哈希)
结构：([4][32][4][32])

// 附注：
// 交易数据序列内的长度采用变长整数标记。
```


#### 交易头结构

简化版伪代码：

```go
TxHeader {
    Version    int32     // 版本
    Timestamp  int64     // 交易时间戳。设定为未来时间可处于链外游离等待
    HashBody   Hash256   // 数据体哈希，Hash(输入摘要+输出摘要)
}
```

已经验证的区块链是安全的，这由区块的哈希链保证。所以实际上交易的解锁数据可以在适当的时候被移除。

也因此，交易的解锁数据并不参与交易ID的计算。


### 出块时间

因为铸造者的甄选和竞争只与历史交易ID相关，因此与Bitcoin不同，这里的出块时间间隔可以设计为一个固定值。

综合权衡和直觉判断，这里选择 `8分钟` 为区块的出块间隔时间。每一个新区块的时间戳需要严格按此数值计算设定，不论铸造节点的当前真实时间是多少。


### 设计参数

> 铸造者为交易的输入项账户，只有花费掉了币金，才有铸造的资格。
> 区块出块时间间隔为固定的 `8分钟`，每一个区块的时间戳都可以由创始区块的时间戳计算而来。


<!--
### CHANGES

取消了原始“**铸造委托**”的设计，原因是：

1. 在铸造委托方案中，钱包服务商通常会成为实际的受托方，这会带来中心化风险。如果流行的钱包App与服务商绑定，则可能是灾难性的。
2. 交易的验证和区块铸造采用**组队校验**模式，这种中心化拥有技术支撑，普通人容易参与。同时因为这只是一种**微中心**，很容易创建，因此去中心化依然不错，故无需借助钱包服务商的专业能力。
3. 铸造者由交易的花费者产生，因此冷挖矿的必要性并无那么急迫，除非地址被重复使用并拥有余额，在线签名才会有一定风险。
4. 哈希相似性计算采用的是签名后的结果。在签名之前，外界并不能评估某个交易ID及其铸造者拥有优势，这种隐匿性可对抗攻击者对铸凭交易的收集（比如贿赂收买）。
5. 攻击者必须自己创建交易来获得铸造竞争的机会，不像钱包服务商可以免费获得大量普通人的委托（成本低廉），因此交易费成本有利于遏制攻击。
6. 实际上，分叉安全性并不完全取决于择优权重本身。竞争链段的长度约束，可以弱化权重值的绝对性优势：只有在“当时”发起攻击，高权重才有意义。链段增长超出后，攻击就失去了逻辑。
-->


<!--
### CHANGES

出块时间间隔：6分钟 => 8分钟

1. 原设计的6分钟可能太紧凑，未来量子风险下可能需要增加负荷，宽松一些更好。
2. 区块头链的数据量更小一些，原1年为7MB，现在8分钟约5MB。如果未来量子风险下需要增加哈希长度，宽容度更大。
   区块头链是任何一个应用都需要常备的数据，小尺寸也更友好一些。
3. 交易确认更慢一些，需要用户多一些耐心……
   如果用户追求速度，可能第三方解决方案更高效，也算是为第三方留出更多机会吧。:(

@2025.0329
-->


## 铸造者的预选与同步

因为评参区块是链末端 `-9号` 区块，所以一个铸造候选者可以提前 `1~8个` 区块时段得知要对比的目标。如果一个节点及时评估并广播自己的铸凭交易，则全网会有充足的时间进行预先沟通。尽量多的参与者加入，可以使得尽可能优质的铸凭交易被发掘出来。


### 择优池

在铸造候选者的预先沟通中，各个节点会收集广播出来的铸凭交易，按权重排序放入一个缓存池，这个缓存池称为 **择优池**。新铸凭交易加入择优池的过程很简单：计算它的权重，如果比池中最差的一个更优，则有序插入并转播，否则忽略。

广播的铸凭交易需要被验证，这由铸造者对铸凭哈希的签名实现（如前）。当出块时间到达时，理论上，择优池中位于前端的铸造者就可以铸造区块并广播了。

> **提示：**
> 在择优池前部成员铸造区块之前，择优池有一个**同步**环节，以此来获得**确定性**。


### 择优池同步

择优池中的成员是动态更新的，为避免刚上线的优质竞争者带来的扰乱（分叉），各节点的择优池应当被提前确定下来（获得确定性），这就需要对择优池进行同步。

在一个新区块成为评参区块（`-9号`）之前，可以有如下分段逻辑：

> **注意：**
> 区块刚创建后无法立即计算铸凭哈希，因为还需要后继块的信息。

1. **广播收集**：区块被创建后，到它成为 `-7号` 区块前的5个区块时段内，与它做相似性对比的铸凭交易可以被广播和收集。
2. **一级同步**：当该区块成为 `-7号` 区块后，择优池的收集和更新结束，进入一级同步阶段。此阶段为补齐不同节点间择优池的差距，耗时1个区块时段。
3. **二级同步**：当该区块成为 `-8号` 区块后，执行二级同步。这是一种确定性同步，同化为授权节点的择优池。用时1个区块时段。
4. **抵达就位**：当该区块成为 `-9号` 区块后，即成为最新时段待创建区块的评比参考目标。

> **注：**
> 区块链初始9个区块的创建没有-9号区块作为参考，这是一个特殊区段。它们有专属的创建规则。


#### 授权节点

择优池大小设计为 `20`，有权同步的节点为择优池中 `后16` 名成员。这基于利益无关性考虑：

*在P2P环境下，时间是一个无法准确的值，系统需要容忍这种模糊性。如果没有限制，高权重的迟到竞争者可以随时把自己加入择优池然后发起同步，因为其高权重，它有可能最终胜选，于是就干扰到了最终的结果，让预先同步失去意义。而且也让同步工作难以按时结束。*

有了这一限制后，排序靠后者没有动力去把迟到的高权重者补入。


#### 一级同步

这一阶段是为了充分补充不同节点收集到的择优池成员，尽可能将所有节点的择优池同化为相同的内容。

发起同步的节点是否有权由如下规则判断：

1. 对方是否在自己的择优池中（不论排名如何）。
2. 对方先提供其择优池前4个成员，以此来证明自己确实属于 **后16** 位成员。

上面的验证合法后，接收剩余的择优池成员并合并，否则忽略。如果是一个新上线的节点，可以先无条件接受几个节点的数据，然后再按上面的规则来处理。


#### 二级同步

通过一级同步之后，全网并不能确保所有节点的择优池数据都相同，也即此时的择优池并没有完全可靠的 **确定性**，因此需要二次同步。

与一级同步不同，此时不再合并择优池数据，而是比较并选取出一个最优集（仅需针对头部**4位**成员权重）。同步者的择优池数据是独立的，也是确定的。

二级同步的成员权利判断与一级同步相同。

> #### 最优集计算
> 针对择优池前4名成员，各自乘以一个系数，合并计算其择优权重（相差），值小者获胜。
> 按第1~4位顺序，系数分别为：`4`、`3`、`2`、`1`，越靠前的权重越高。


### 设计参数

> 择优池容量为 `20名` 候选者。
> 择优池中权重排序在 `4名` 之后的 `16位` 候选者有权发起择优池同步。
> 有权同步的候选者在两级同步中都只有 `1次` 同步的权力。



## 区块铸造

当出块时间将要到达时，理论上择优池中的全部候选者都有权出块，但因为区块竞争的条件很明确，通常只需要前端候选者出块就可以了。

> **提前收敛：**
> 存在一个约定：由于网络有延迟，校验节点会提前3~5秒钟中止当前可打包交易的转播。


### 择优凭证

区块铸造的权重证明包含如下几项信息：

- 交易定位：年度、交易ID。
- 铸造者：首笔输入的接收者地址。
- 签名数据：铸造者对铸凭交易的签名（如前 `signData`）。
- 权重值：哈希相似性对比中的相差。待验证。

<!--
设计错误：
此处的**权重值**即会作为前面铸凭哈希计算里的 **X信息**。

原因：
其实在当前区块时段内，下一个区块的择优池已经明确了。权重值已知。
-->


### 铸造冗余

区块的铸造者通常就是择优池中的第一名，但网络世界可能存在任何异常，如果第一名候选者正好离线了，区块铸造应当正常进行。

所以在现实的运行中，作为一种约定，择优池中的**前4名**都会铸造区块并发布，按排名顺序延时**10**秒广播（减少冗余负载）。另外也有一个简单的转播策略：如果已经收到了一个高权重且合法的区块，则新抵达的低权重区块简单忽略。如果第2-4名铸造者收到了冠军铸造者的区块（且合法），当然也就可以不再发布。

> **注：**
> 如果择优池前4名都没有发布区块（基本上不可能），作为一种异常补救，后续16名成员可以按顺序发布区块，时间间隔相同。
> 当然，如果后续16位成员都下线或没有发布区块？好吧，，这条链可以死了，没有挽救的必要……😂


### 时间截止

区块不能收录未来的交易（按时间戳计算，包含出块时间点），这是一个基本设计。因此铸造者没有理由延时等待更多的交易抵达，新区块通常会在预定的时间开始创建、广播和验证。

区块的广播抵达和区块数据的同步完成不是一个概念，只要可验证的区块证明抵达全网，区块的数据同步就可以稍晚一点。


### 设计参数

> 铸造者按择优池中的排名，`前4名` 候选者按 `10秒` 间隔相继出块，但收到高权重区块（合法）后停止。
> 如果前4名候选者未出块，择优池后**16**名可弥补出块，间隔时间相同。




-------------------------------------------------------------------------------

上一篇：[导读](0.导读.md)<br>
下一篇：[共识模型-端点约定](2.共识模型-端点约定.md)<br>
