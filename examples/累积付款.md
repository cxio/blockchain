## 累积付款

分期支付，直到最后一笔付款完成，收款方才能花费。

如果最后支付超过时限，付款方可以赎回（**注**：较不利于收款方）。主要用于表达付款方诚意，但最后依然可以反悔（不买）。


### 条件

双方共同构造一个双重签名地址（`1/2`），任一签名皆可使用。

双重签名的公钥地址序列假设为`「付-收」`序，即：[0] = 付款者，[1] = 收款者。


### 脚本

#### 分期支付

每一笔支付都包含一个相同的哈希屏障，也包含一个过期赎回分支。

```go
// 解锁数据
// DATA{<hashSource>}          // 哈希源，由付款方在凭信转移时公开
// {2}                         // 验证类型（多签）
// <flag>                      // 授权标记
// <[sig]>                     // 签名数据
// <[pubKey]>                  // 公钥序列
// <[pubHash]>                 // 公钥哈希（地址）序列
// @POPS[5]                    // 弹出栈顶5项到实参区

// 锁定脚本
SYS_CHKPASS                         // 系统内置验证
SYS_TIME{Stamp} {<expireTime>} GT   // 是否过期
IF{                                 // 是：
    MULSIG[0] PASS                  // 由付款方签名，赎回通过
    EXIT                            // 结束脚本
}                                   // 否：
MULSIG[1] PASS                      // 是否由收款方签名，真时通过
FN_HASH256                          // 栈顶剩余项为<hashSource>，计算其哈希
DATA{<hashResult>}                  // 预置源哈希结果
EQUAL PASS                          // 栈顶两个序列相等比较，真时通过
```

**附：**
如果收款方在过期之后依然可以花费，用以下脚本。

```go
// 解锁数据
// …… 同上

// 锁定脚本
SYS_CHKPASS
TRUE                            // 标的值：true
MULSIG[0] MULSIG[1] SHIFT[2]    // [付款方, 收款方]
SWITCH{
    CASE{       // 付款方赎回
        SYS_TIME{Stamp} {<expireTime>}
        GT PASS
    }
    CASE{       // 收款方转移（不受过期影响）
        FN_HASH256
        DATA{<hashResult>}
        EQUAL PASS
    }
}
```


#### 了结触发（凭信）

由付款方在分期支付期间创建，在支付完成之后花费。提供哈希源，触发收款方转移收款。

```go
// 解锁数据
// DATA{<hashSource>}      // 哈希源，花费时公开
// {1}                     // 签名方法（单签）
// <flag>                  // 授权标记
// <sig>                   // 签名数据
// <pubKey>                // 公钥
// @POPS[4]                // 提取实参

SYS_CHKPASS             // 系统内置验证

TOP                     // 引用栈顶项<hashSource>（复制）
FN_HASH256              // 计算哈希结果
DATA{<hashResult>}      // 结果预置
EQUAL PASS              // 比较，相同则通过

@POP                    // 取栈顶项<hashSource>
OUTPUT BUFDUMP          // 导出触发外部监听（收款方及时转移收款）
```

> **注：**
> 付款方应当在可赎回之前花费该凭信，即期限应当设置得足够长。
