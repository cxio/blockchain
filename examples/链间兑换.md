## 链间兑换

两条区块链上的币金可以相互兑换：*不是币金跨链支付，而是两对账户本链转账*。

- 假设甲有A链上的币金 `a1`，乙有B链上的币金 `b1`。
- 甲提供一个B链上的收款地址 `B2`，乙将 `b1` 发送到 `B2`。
- 相应的，乙提供一个A链上的收款地址 `A2`，甲发送 `a1` 到 `A2`。

兑换完成。


### 准备

甲乙共同构造A链和B链上的多重签名收款地址 `A2` 和 `B2`，签名模式为 `1/2`（任一签名即可），锁定脚本包含一个哈希屏障和时间限定。

假设多重签名地址的公钥哈希顺序为`「甲-乙」`，即：[0] = 甲，[1] = 乙。


### 流程

1. 甲先支付（A链）：`a1 => A2`，设置一个哈希屏障和过期赎回分支。
2. 乙看到该交易后，在B链上执行支付：`b1 => B2`。设置相同的哈希屏障，同时也包含过期赎回分支。

等待两笔交易确认……

1. 甲转移B链中的币金。解锁脚本需提供哈希源（`<hashSource>`），即向乙公开。
2. 乙获取哈希源（`<hashSource>`），转移A链中的币金。

兑换完成。


### 脚本参考

#### A链支付脚本（甲方：`a1 => A2`）

```go
// 解锁段
// 在乙转移A链币金时提供。
DATA{<hashSource>}                  // 哈希源，甲方创建并保留
{2}                                 // 验证类型（多签）
<flag>                              // 授权标记
<[sig]>                             // 签名数据
<[pubKey]>                          // 公钥序列
<[pubHash]>                         // 公钥哈希（地址）序列
@POPS[5]                            // 弹出栈顶5项到实参区

// 锁定脚本
// 此为交易中的输出脚本，公开可见。
SYS_CHKPASS                         // 系统内置验证
SYS_TIME{Stamp} {<expireTime>} GT   // 是否过期
IF{                                 // 是：
    MULSIG[0] PASS                  // 由甲签名，通过（赎回）
    EXIT                            // 结束脚本
}                                   // 否：
MULSIG[1] PASS                      // 是否由乙签名，真时通过
FN_HASH256                          // 栈顶剩余项为<hashSource>，计算哈希
DATA{<hashResult>}                  // 预置哈希结果（哈希屏障）
EQUAL PASS                          // 栈顶两个序列相等比较，真时通过（乙转移）
```


#### 兑换模型

甲创建的兑换支付脚本需要符合预定的格式，才能保证乙正常地转移币金。

这种预定的格式由兑换模型来保证。

乙检查甲的兑换脚本是否符合格式，提取时间戳和哈希屏障数据，构建B链上的支付交易。

```go
MODEL{                              // 模式匹配
    SYS_CHKPASS
    SYS_TIME{Stamp} {?} #[32] GT    //1: 提取时间戳
    IF{                             // if指令，进阶匹配
        MULSIG[0] PASS              // 严格匹配
        EXIT                        // 严格匹配
    }
    MULSIG[1] PASS                  // 严格匹配
    FN_HASH256                      // 严格匹配
    DATA[32]{?} #[32]               //2: 提取32字节的哈希结果（哈希屏障）
    EQUAL PASS                      // 严格匹配
}                                   // => ([expireTime, hashResult], Bool)
PASS                                // 匹配是否通过
@POP OUTPUT                         // 导出提取的两个值
BUFDUMP                             // 触发外部监听（乙构建B链的支付脚本）
```


#### B链支付脚本（乙方：`b1 => B2`）

```go
// 解锁段
// 在甲转移B链币金时提供。
DATA[32]{<hashSource>}              // 哈希源，甲转移时公开
{2}                                 // 验证类型（多签）
<flag>                              // 授权标记
<[sig]>                             // 签名数据
<[pubKey]>                          // 公钥序列
<[pubHash]>                         // 公钥哈希（地址）序列
@POPS[5]                            // 弹出栈顶5项到实参区

// 锁定脚本
SYS_CHKPASS                         // 系统内置验证
SYS_TIME{Stamp} {<expireTime2>} GT  // 是否过期
IF{                                 // 是：
    MULSIG[1] PASS                  // 由乙签名，通过（赎回）
    EXIT                            // 结束脚本
}                                   // 否：
MULSIG[0] PASS                      // 是否由甲签名，真时通过
TOP                                 // 栈顶为<hashSource>，引用（复制）
FN_HASH256                          // 计算<hashSource>的哈希
DATA{<hashResult>}                  // 哈希结果预置（屏障）
EQUAL PASS                          // 栈顶两个序列相等比较，真时通过（甲转移）

@POP OUTPUT                         // 导出栈顶<hashSource>
BUFDUMP                             // 触发外部监听（乙注册处理）
```

> **注意：**
> 甲应当先在本机私有环境下提供哈希源执行脚本，如果成功才对外发布。


### 注意事项

- 双方应当在赎回期限之前尽早完成币金的转移。
- 两个有效期应当在相近的时间点结束，避免赎回生效后，某方发起不应有的赎回（双花竞争）。
