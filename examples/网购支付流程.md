# 网购支付流程

## 购买

客户购买商品，付款给店家但临时冻结。客户取货后确认，解冻支付。


### 流程

- **购买**：客户付款给商家，锁定脚本包含一个哈希屏障。货款临时冻结。
- **物流**：商家发货，给物流支付的运费里包含同样的哈希屏障。运费也临时冻结。
- **签收**：物流送达客户，客户验货签收，提供哈希源（公开）。
- **结账**：物流取得哈希源，提取运费，商家也同样提取（转移）货款。流程结束。


### 脚本

#### 购买支付输出

此交易由客户创建。

```go
// 解锁数据
// {
//      {1}             // 签名方法（单签）
//      <flag>          // 授权标记
//      <sig>           // 签名数据
//      <pubKey>        // 公钥
// }>> 载入环境
//
// 解锁脚本
// <hashSource>        // 哈希源，客户创建并持有

// 锁定脚本
SYS_CHKPASS             // 内置校验（从环境读取实参）

FN_HASH256              // 对哈希源计算哈希
DATA{<hashResult>}      // 哈希结果预置
EQUAL PASS              // 两者相同时通过
```


#### 运费支付输出

此交易由商家创建。

```go
// 解锁数据
// {
//      {1}             // 签名方法（单签）
//      <flag>          // 授权标记
//      <sig>           // 签名数据
//      <pubKey>        // 公钥
// }>> 载入环境
//
// 解锁脚本
// <hashSource>         // 哈希源，由客户签收时提供

// 锁定脚本
SYS_CHKPASS             // 内置验证（从环境读取实参）

TOP                     // 引用<hashSource>（复制）
FN_HASH256              // 对哈希源计算哈希
DATA{<hashResult>}      // 哈希结果预置
EQUAL PASS              // 两者相同时通过
END                     // 公共验证结束

@POP                    // 提取哈希源<hashSource>
OUTPUT BUFDUMP          // 导出，商家监听提取，完成货款转移
```

> **注：**
> 商家的货款提取需等待物流先行提取运费，才能得知哈希源。


## 退货

客户尚未签收（未公布哈希源），货款资金处于冻结状态。

商家主动先行垫付（退赔，金额双方协商），化解客户支出。然后商家取货、客户收款（公开哈希源）、商家取款。完成退货流程。


### 流程

- **先行垫付**：商家与客户协商返还金额，商家创建返还支付交易，包含同样的哈希屏障。
- **客户收款**：客户提供哈希源，提取商家返还的币金。
- **商家结账**：商家取得哈希源，提取用户购买时支付的币金。对冲先行的垫付。
- **运费问题**：快递也取得哈希源，提取由商家或客户支付的运费。


### 脚本

#### 退款支付（A）

此交易由商家创建（先垫付）。**注**：与运费支付脚本相同（包含监听段）。

```go
// 解锁数据
// {
//      {1}             // 签名方法（单签）
//      <flag>          // 授权标记
//      <sig>           // 签名数据
//      <pubKey>        // 公钥
// }>> 载入环境
//
// 解锁脚本
// <hashSource>         // 哈希源，由客户取款时公开

// 锁定脚本
SYS_CHKPASS             // 内置验证（从环境读取实参）

TOP                     // 引用<hashSource>（复制）
FN_HASH256              // 对哈希源计算哈希
DATA{<hashResult>}      // 哈希结果预置
EQUAL PASS              // 两者相同时通过
END                     // 公共验证结束

@POP                    // 提取哈希源<hashSource>
OUTPUT BUFDUMP          // 导出，商家监听提取，完成货款转移
```

此退款方式有一个潜在问题：*如果客户不收退款（哈希源不公开），商家也无法取出货款*。

这可能导致某种攻击：同业竞争者构造大量的购买退款订单，间接锁死商家的资金，打击对手的现金流。


#### 退款支付（B）

为避免这一状况，退款支付可以添加一个延时赎回逻辑。

但此时需要双方构造一个 `1/2` 的多重签名地址，假设为 `[商家-客户]` 序。

```go
// 解锁数据
// {
//      {2}                     // 验证类型（多签）
//      <flag>                  // 授权标记
//      <[sig]>                 // 签名数据
//      <[pubKey]>              // 公钥序列
//      <[pubHash]>             // 公钥哈希（地址）序列
// }>> 载入环境
//
// 解锁脚本
// <hashSource>                 // 哈希源，由客户取款时公开

// 锁定脚本
SYS_CHKPASS                         // 内置验证（从环境读取实参）

TOP                                 // 引用<hashSource>（复制）
SYS_TIME{Stamp} {<expireTime>} GT   // 是否过期
IF{                                 // 是：
    MULSIG[0] PASS                  // 由商家签名，赎回通过
    EXIT                            // 结束脚本
}                                   // 否：
MULSIG[1] PASS                      // 由客户签名
FN_HASH256                          // 对哈希源计算哈希
DATA{<hashResult>}                  // 哈希结果预置
EQUAL PASS                          // 两者相同时通过
END                                 // 公共验证结束

@POP                                // 提取哈希源<hashSource>
OUTPUT BUFDUMP                      // 导出，商家监听提取，完成货款转移
```
