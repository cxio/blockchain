# 端点约定

在P2P的网络里，不同于传统「客户端/服务器」的主从逻辑，相互连接的节点是一个平等的关系：一个节点从对方获取服务的同时，也为对方提供服务。节点既是客户端也是服务器，两端依靠预先定义的规则交互和协作。

这是一个由契约维系的去中心化世界，在这里，所有的端点都遵循共同的规则或约定，这些规则和约定，统称为 **端点约定**。

端点约定有两种：

- **协议**：需严格遵守，违背即非法。有最终的合法性验证手段，不遵守会破坏系统，视为错误。
- **共约**：宽松的约束，靠自觉遵守。无需验证也无法验证，如果大家都遵守会很好，少数不遵守也不会致命。

共约没有强制力。但为什么不遵守呢？如果没有不遵守的利益驱动，应该就不是一个问题。

> **注**：在下文中，节点有时也称为端点，不必刻意区分。


## 区块

### 出块时间

铸造者的竞争和优选只与历史交易有关，这与Bitcoin不同。因此出块时间间隔可以设计为一个固定的值。综合权衡，**6分钟** 可能是合适的。

从创始块开始，每一个区块的时间戳都通过高度和时间间隔计算出来（精确值），而不是铸造者节点自己本机的实际时间。


### 区块铸造

当出块时间将要到达时，理论上择优池中的全部候选者都可以出块，但因为区块竞争的条件很明确，通常只需要前端候选者出块就可以了。

节点对最终区块的认可除了验证区块的合法性外，该铸造者还必须是择优池中的成员。


### 铸造冗余

区块的铸造者通常就是择优池中的第一名，但网络世界可能存在任何异常，如果第一名候选者正好离线了，区块铸造需要正常进行。

所以这里的规则是：

*择优池中所有的候选者都可以打包出块，但按顺序执行，间隔 `15秒` 广播*。

当然，如果一名候选者已经收到了排名靠前者打包的区块，且验证通过，那他就不用再发布自己的区块了。

这样，在网络中现实传输的区块并不会太多，因为15秒的广播延迟应该足以阻止后续不必要的发布了。这一延迟考虑了区块广播到全网的时间，以及其它节点对交易差异部分的获取和验证时间。当然，这是一个粗略权衡值。

> **注：**
> 新区块的构建仅依赖前一区块的ID、当前交易集和UTXO/UTCO集指纹。

为了尽可能地收集交易，首个区块将按标准出块时间点（区块时间戳）延后**30**秒发布。即：区块时间戳是标准点时间，在此时间之后30秒才开始发布。


### 区块发布

区块不收录未来的交易（即时间戳*在区块时间戳之后*的交易）。

假设用户都用真实的时间创建并发布交易，在适当的延时后，这些交易应当都已抵达全网，铸造者没有理由等待更久。新区块会在预定的时间发布。

区块的广播和区块内容的验证并不需要同时完成，只要适当的区块证明抵达并验证通过，即可快速转播。

具体策略可能是这样：

1. 如果区块的Coinbase合法，且由局部哈希校验树生成的区块头合法，即先行转播。**注**：铸造者已在择优池中验证过。
2. 同步区块打包的交易ID序列，如果其中有自己缺失的交易，即时请求并验证它们……
3. 最后对完整的交易ID序列计算哈希校验树，构造区块头对比，完成整个区块的合法性验证。

注意：在完整的合法性判断之前，择优池中的候选者*不应当停止*发布区块。


### 区块竞争

合法的区块可能有多个，它们之间的竞争规则如下：

- 对于同一铸造者创建的区块，交易费收益低的区块胜出。这可以避免铸造者多签的问题。
- 对于候选铸造者冗余发布的区块，如果币权销毁量大大高于（3倍于）主区块，则候选区块胜出。这是对区块包含交易量的约束。

> **注：**
> 交易量约束规则详见于「组队校验」的[交易量约束](附.组队校验.md#交易量约束)部分。

这里的**主区块**是指竞争中权重相对最高的那个区块，并不特指择优池冠军创建的那个区块。



## 分叉

通过择优池预选和同步，铸造候选者有了很好的确定性，但这并不能完全保证区块链不出现分叉。如果因为某种原因出现了分叉，比如网络分区或某种攻击，就需要一种规则来决出胜负，找出主链。


### 分叉竞争

节点间的交互中会包含当前区块的ID，如果同一个高度上有不同的ID，就是出现分叉了。


#### 链段的竞争

不用于Bitcoin的最长链竞争，本设计是固定的出块时间间隔，因此每一条分叉都是等长的。为了体现原始主链的竞争力，这里采用限定长度链段的综合评估来实现。

- 分叉必须成长到**25个**区块后（150分钟）才评比。
- 逐区块平级对比：计算各自Coinbase交易里存储的凭证的铸凭哈希，小者胜出，谁先胜出过半谁赢。
- 如果分叉已经超出限定长度才发现（隐秘分叉），即视为另一条分叉链不予理会。

> **注记：**
> 限定长度不只是为了增加攻击难度，如果网络因为某种原因分区了，一个缓冲期是必要的。


#### 安全性

分叉评比仅针对末端的25个区块，超出长度的分叉被视为一个合法的支链，所以实际上这会带来一种「绝对的」安全：

*如果一笔交易已经被25个以上区块确认，那它就没有什么可担忧的了*。


#### 附：主链篡夺攻击

强大的攻击者可能创建一条隐秘的分叉，等待25个区块的末端竞争过去之后，发布并声称自己才是正统的主链。这基本上是一种社会化攻击，除了最长链机制的PoW，其它区块链很难从克服。

不过这本质上是一种版权争夺，属于法律解决的范畴。它不会导致双花攻击，两条链上的支付都有效。


### 分叉处理

发现分叉后，节点可以采取如下策略：

1. 缓存全部分叉。
2. 实时评比不同分叉的铸凭哈希，切换主链到胜出更多的分叉。
3. 根据限定长度（25个区块）规则，如果有一个分叉已经胜出过半（13），即视其为主链。

如果分叉竞争已经完成，失败的分叉上的交易可以合并到主链上来。因为都是面对同样的交易集，所以需要合并的交易应该不多。

> **注：**
> 新币需要经历25个区块之后才能兑现，所以这里不会有新币输入源无效的问题。



## 其它

### 关于零确认

交易在网络上的传输没有先后顺序，原则上，交易一旦广播出去便无法撤回。

如果一位用户发送了一笔失误的交易（比如接收者错误），应当允许他立即重新发送一笔正确的交易，但这就出现了双花。通常，铸造者倾向于收录交易费更高的交易，所以如果用户要纠正失误，应当在区块打包前发送且提供更高一些的交易费。

但双花也可能源于攻击。如果接收者认可零确认，在收到前一笔交易后发货或让顾客离开，而最终进入区块的却是另一笔交易，这就导致收款者的损失了。

从系统上设计零确认的安全机制会比较复杂，这里只作简化处理：*如果一个节点发现双花交易，应在当前App上发送警告提醒用户*。

因此对于大笔金额或十分重要的交易，用户应当等待足够的区块确认。


### 最低交易费

交易费是矿工的重要收入来源，提供服务收取费用是一种正常的逻辑。

区块收录的交易数量是有限的，交易的入块竞争可能带来交易费的竞争。虽然如此，一个恰当的最低交易费约束是有益的，它可以避免为铸造资格而“刷交易”的成本不至于太低。

最低交易费由前期区块的交易费平均计算而来，具体规则为：

*节点每 `6000个` 区块（25天）统计一次，取平均值的 `1/4` 作为当前阶段的最低交易费*。

这是一个*共约*，是否收录低于最低交易费的交易，决定权在铸造者本身。

> **警告：**
> 节点不应当阻止低交易费交易的转播，因为铸造者可能已经收录了它。
> 这种阻止会导致部分节点无法验证该区块是否合法。


### 交易过期

未被收录的交易超过一定时间后会被作废，这个期限设计为24小时（`240个` 区块）。

过期是按交易的时间戳判断的，它的意义在于：

1. 缩减未确认交易的规模。
2. 提升时间因子的价值，为某些应用提供一种*确定性*。

人们不应当期待一笔24小时都未确认的交易依然有效，持续等待长时间其实也是一种负面的体验。


### 全网通告

为了在零散自由的P2P网络上保有一定程度的协作，设计保留一个极简的中心化机制：**全网通告**。

全网通告仅限于文本消息，任何参与组网的节点都会收到，且禁止基于此做功能扩展（比如单击链接升级更新，这可能带来风险）。

通告消息拥有签名，签名者由官方App内置或社区公告（公钥清单）授权。



## 设计参数

- 区块的出块时间间隔为 `6分钟`，每一个区块的时间戳都由创始块的时间戳计算而来。
- 择优池中的候选者按顺序发布区块，时间间隔为 `15秒`，首个区块按标准时间点延后 `30秒` 出块。
- 分叉必须成长到 `25个` 区块后（2.5小时）才评比。同时这也是新币可以花费的*确认数*。
- 最低交易费由前期 `6000个` 区块的平均交易费计算而来，取其 `1/4` 作为最低费用。
- 超出 `240个` 区块都未收录的交易视为过期失效。这是一个*协议*，不可违背。即铸造者不能收录这样的交易。
- *全网通告*是唯一一个中心化机制，仅传递文本消息并禁止基于此做直接的功能扩展。




--------------------------------------------------------------------------

上一篇：[共识：历史证明（PoH）](1.共识-历史证明（PoH）.md)<br>
下一篇：[公共服务](3.公共服务.md)<br>
