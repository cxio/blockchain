//////////////////////////////////////////////////////////////////////////////
Copyright (c) 2019 @cxio/blockchain

    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.3
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


## 组队校验

### 前言

缘于去中心化的端点独立性，区块链的工作逻辑实际上是「单机」。如果交易量太大，性能不足的机器是无法成为一个正常的节点的。这也是当前区块链系统交易规模受限的原因之一。去中心化的单机模型拥有庞大的冗余性，排除分权的需求（已经过剩），这样的冗余实际上是一种浪费。因此，多个端点协同工作，分担负载并共同组成为一个逻辑上独立的单元是有意义的。

实际上，交易天生就拥有独立的逻辑，一笔交易就是一些信用完整转移的过程，拥有独立的可验证性（除了部分跳转指令需要进阶验证）。一个端点可以最少仅验证一笔交易，不同的端点验证不同的交易，配合恰当的分工管理和冗余复核保证，多机协作共同完成一个区块全部的工作是可能的。

**基本原则**

一个协同工作的组队称为一个「校验组」，是一个逻辑上的单体。组内以**冗余校验**和**扩展复核**为保障，避免恶意端点行为造成的错误。不同的校验组之间同步区块时，会即时回馈错误的交易ID，这样就可以实现错误的快速封堵和及时纠正弥补。

- 身份标识。端点以区块链地址为身份，用于身份识别和收益分成。
- 自由组队。一个端点可以自由加入任一校验组，能力强的单机也可以同时加入多个组。
- 半开放性。因为涉及部分信任的问题，可能需要注册（微矿池）。



### 4种角色分配

1. **管理层**：负责组内交易校验工作的分发（冗余控制）、合法交易汇总、节点业绩记录，以及与外部的区块交互等。
2. **守卫者**：接收外部传入的交易，执行「首领校验」，提交验证通过的交易到管理层，并传递给其它组的守卫者。
3. **校验员**：向管理层请求交易执行完整校验，无论结果如何都向管理层提交反馈，同时向其它组的守卫者传送校验合法的交易。
4. **UTXO缓存器**：缓存当前UTXO集合并提供查询服务，是组内的公共服务，用于双花检查和降低参与者的硬件门槛。

<img src="images/checkteam-1180x800.png" width="1180" alt="校验组成员内外关系图">


#### 管理层

管理包含两种基本职能：**广播**和**调度**，它们收集并缓存从守卫者那里提交上来的准合法交易（仅通过首领校验），接受校验员的申请，派发交易的完整校验任务。如果组内有成员拥有铸造资格，则与铸造者协作构造区块并广播出去。

管理层与外部其它校验组的管理层建立连接，形成一个以校验组为单元的管理者P2P网络。


**广播：**

- 打包交易构造区块，接收组内铸造者的Coinbase交易，验证其合规性。
- 如果本组拥有铸造区块的资格，收录Coinbase交易，提供交易哈希树根供铸造者签署。计算区块头，向网络广播区块。
- 如果本组没有铸造资格，接收并验证其它组发布的区块，即时回馈和中继。
- 参与组内成员铸造预选时的择优池交互和同步（因为管理层是内部成员联系的中介）。


**调度：**

- 接收组内守卫者传入的经过首领校验的交易，存入待验证交易池。
- 接收校验员的工作申请，检索待验证交易池派发完整校验的工作（传送交易数据）。
- 接收校验员的验证结果反馈，评估/执行必要的复核管理工作（按设定的冗余度派发给其它校验员）。
- 存储已经确认合法的交易集，向广播机同步。
- 记录组内各成员的工作业绩，用于最终酬劳评估。

**连接关系：**
> 组内：守卫者、校验员。<br>
> 外部：其它校验组管理层。<br>


#### 守卫者

除了与本组的管理层建立连接之外，更重要的是与其它组的守卫者和校验员连接，接收它们传入的交易，做简单的首领校验。
首领校验为初步验证（见下），合法的交易被传递到管理层和其它组的守卫者（以实现交易的快速广播）。

一个校验组中，仅有守卫者接收从外部传来的未验证交易，它们充当交易进入本组的大门护卫。
因为交易未经全面验证，为预防恶意的行为，守卫者需从管理层获取交易黑名单（首领输入合法但其它输入非法的交易），以屏蔽恶意行为的影响。

**连接关系：**
> 组内：管理层。<br>
> 外部：守卫者、校验员。<br>

#### 校验员

向管理层请求校验任务，执行交易的完整验证并反馈结果。与其它组的守卫者建立连接并提供验证合法的交易。

校验员群体需要较大的冗余度，管理层通过冗余复核的方式尽量排除成员错误反馈的恶意行为。
待验证的交易是初次验证还是复核验证对校验员来说是透明的（不知情）。

**连接关系：**
> 组内：管理层。<br>
> 外部：守卫者。<br>


#### UTXO缓存器

由于交易被分散校验，双花检查就需要由缓存服务器来提供。通常，守卫者和校验员对UTXO的请求包含来源交易ID，如果交易验证通过，该ID就会被缓存器记录下来，双花交易就可以被发现了。缓存器会根据规则判定双花交易可否放行（时序保障），然后通知给请求者。

一名捣蛋者可能向缓存器提供假ID以制造假双花，所以缓存器在双花出现时还需要与管理层协作，判断前一个交易ID是否真实。如果捣蛋者需要完成捣蛋，就需要同时欺骗管理层，但这样就会被检查出来。或者，管理层也可以从缓存器处获得更多信息。

另一方面，UTXO缓存对一个单独的守卫者或校验员来说，可能是一笔不小的开销。内部公共的UTXO缓存服务是划算的，服务器也不需要太多，2-3个的冗余度应该已经足够。因为当前时段的交易是明确的，缓存的命中率实际上很高。

**连接关系：**
> 组内：守卫者、校验员、管理层。<br>
> 外部：无（非指blockqs公共服务）。<br>


#### 附：首领输入与首领校验

为了支持交易尽快地在网络上传播，便于全网更有效率的处理交易，端点对于接收到的交易，仅验证其首笔输入是否合法。该首笔输入即称为首领输入（Leader TX），仅验证首领输入的行为称为首领校验。

为了避免攻击者构造大量首领输入合法但后续输入非法的交易实施洪流攻击，这里有一个简单的约束和一个黑名单抑制措施：

- **约束**：首领输入必须是全部输入里币权最大者。
- **抑制**：完整校验失败的首领输入会进入黑名单。

**安全性**

统计全部输入的币权需要查询UTXO缓存服务器，因此攻击交易里的后续输入必须使用有效输出。攻击者可以使用别人的低币权交易（无需正确签名）充数，但这在校验员处会很快被检查出来，并不能带来更多的负载消耗。而如果尽量采用自己控制的输出（仅一笔非法即可），则必需满足首领输入币权最大的要求，如果这些首领输入被纳入黑名单，连续的攻击就很难实施。

考虑容忍偶尔的失误，进入黑名单并不是永久的，这个期限可能在3天以上。如果这是一个失误，或者攻击者想要花掉这笔输入，他们要么等待有效期过后，要么可以将之编入一笔有更高币权首领输入的交易里。这是允许的。

> **注意：**<br>
> 首领校验只是交易快速传播的一种策略，由校验组的守卫者实施。<br>
> 首领输入币权最大的规则，并不在交易进入区块的最终合法性规则里。<br>
> 首领校验包含对双花的「时序保障」处理，以配合零确认的安全机制。<br>



### 校验的冗余度与可靠性

#### 冗余校验

同一笔交易由多名校验员执行完整的验证（含首领输入），如果校验员全都反馈为合法或非法，则视为合法和非法，如果其中至少有一名判断为非法，则纳入扩展复核的范围。通常，校验员的冗余度不低于3，即一笔交易会交由3名以上的校验员验证，但这也取决于校验组自己的权衡。

#### 扩展复核

对于在冗余校验里得到部分非法判断的交易，管理者会将它们重新派发给另一些校验员验证。这就是扩展复核。为了获得足够的可靠性，除了依然保持必要的冗余度外，这里还设计了两级复核机制：

- **一级复核**：报错者为零，交易视为合法。报错者超过半数，交易视为无效，低于半数，则进入二级复核。
- **二级复核**：如果有一名校验员报错，交易即视为无效。通常，二级复核的冗余度不高，且多交给信誉度较好的校验员执行。

在一个校验组中，二级复核判断为非法的交易并非就再也没有机会重审了。如果这笔交易实际上是合法的，它就很可能在其它校验组里也合法，而如果它被打包进了区块里，当区块同步到当前组时，这笔交易就会被重新认真验证。

> **注记：**<br>
> 算法可能并不需要记录校验员验证了哪些交易，而是只需要借助于随机分派任务即可。<br>
> 更多的校验员可以产生更好的随机性，这可能是一个正向因子，可以促进更多廉价客户机的参与。<br>



### 铸造者预选与铸造约束

组队校验模式下的校验组是一个逻辑独立的单元，但这并不表示这个逻辑单元的连网也是个体形式（单独的连入连出）。相反地，各组成员之间的连接实际上几乎是完全自由的，它们只有一些简单宽泛的角色约束，这是一个拥有微规则但依然P2P的网络。

所以铸造者的预选并不需要特别的适应设计，如前规则依然适用。唯一的增强是管理层参与本组铸造预选数据的传递，因为组内成员之间是没有连接的，管理层是所有组员共享信息的结点。

组内成员是否拥有铸造区块的资格，管理层不一定预先知道，一位铸造者也可能参与了多个校验组同时工作，因此铸造者签名哪个校验组的区块并不确定。另外，铸造者也可能同时签署多个校验组的区块，而这些区块并不相同，这会带来混乱。


#### 多签约束

铸造者签署多个区块的原因可能是不清除所签区块的收益，或者后来的区块打包了更多的交易，收益增加让铸造者有了重新签署的动机。不清楚收益的多签带来混乱，而更多收益区块的重签则会影响区块的正常出块。因此需要一个规则来制约或筛选多签的区块。

**规则：收益最低的区块胜出，进入区块链。**

这是一个简单的规则，但它可带来如下效果：

- 铸造者趋向于尽量晚签署区块，以尽可能多地收集交易。但受制于交易的传输约定，签署会在恰当的时间执行。
- 铸造者会主动避免多签，因为如果后一次签署的区块收益更低，反而带来损失，而如果收益更高却也无用。


#### 信息分离的约束

Coinbase交易负责构建激励的分配，一个校验组中的激励分配通常是有要求的，比如要求把奖励发送到管理者掌控的地址，以便于管理者最后按劳分配酬金。因此除了符合通用的规则外，Coinbase交易也不能随意构建，管理层需要检查交易是否符合要求。这就是交易哈希树根需要签名的原因。见如下图示：

<img src="images/list4th-1050x700.png" width="1050" alt="四元链哈希树结构" />

交易的四元链哈希树根（Root）和UTXO指纹由铸造者签名，然后签名数据与被签名数据一同计算区块验证根（CheckRoot）进入区块头。

UTXO指纹可以从组内的UTXO缓存服务器（或区块查询服务网）获得，因此管理层对铸造者唯一的制约是交易的哈希树根信息。铸造者是离散的校验员或守卫者，它们没有全部交易的ID集合，因此正常的铸造流程是：

1. 铸造者构造Coinbase交易，向管理员提交，申请签署。
2. 管理员选择最优的申请者，验证其Coinbase交易的酬劳分配是否合规。
3. 合规则添加Coinbase交易的ID到交易ID集，构造交易集的哈希校验树根，提供给铸造者签署。
4. 铸造者签署数据（Root+UTXO指纹），提交给管理层同时也自行发布。

> **不足之处：**<br>
> 普通组员铸造者有管理层的制约，但若管理者本身就是铸造者，则无法监督了。<br>
> 管理者需要招募组员参与工作，或许信誉作为一个市场因子稍有作用吧？<br>



### 关于最优规模

一个校验组的规模并不是越大越好，相反，这个规模需要适度轻量，恰到好处。单个区块的交易量是有限制的，如果按最多64k笔交易，每秒处理182笔交易的规模估算，由50-80个客户机组成一个校验组可能就绰绰有余了。

由校验组构建的区块链网络是一个有着某些「微结构」的P2P网络，端点对交易验证的认领是自由的，能力强的可以多处理一些，反之则量力而行，这是一种自适应的模型。端点加入哪个校验组或多少个校验组也是自由的，基本上，这是一种自由市场的模式，拥有良好的去中心化特性。



-------------------------------------------------------------------------------

上一篇：[脚本基础指令集](6.脚本基础指令集.md)<br>
下一篇：[附2：攻击与安全](附2.攻击与安全.md)<br>
