//////////////////////////////////////////////////////////////////////////////
Copyright (c) 2019 - 2025 @cxio/blockchain

    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.3
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


区块链是区块的链表，区块包含了不定数量的交易，如果有一笔交易进入了区块，就相当于该交易成了事实，也称为被 *确认*。

区块是交易的集合，任意节点都可以验证交易然后打包创建，但谁打包的区块才算数呢？这就需要共识，一种机制，来决定谁打包的区块可以进入主链，也即：谁拥有区块的铸造权。


## 基于历史的证明（PoH: Proof of Historical）

交易ID是交易数据的哈希摘要，拥有很强的随机性，如果把交易ID用作一个评选因子，是否就可以获得某种随机的筛选呢？

交易是任何一位用户都可以创建的，拥有普适性，同时，交易ID作为历史数据无法更改，它又拥有确定性。与传统的PoS权益证明不同，交易ID也与财富无关，没有富者越富的逻辑，所有的ID都是平等的，唯一增加获选机会的方式就是创建更多的交易。

创建交易有交易费成本，但毫无疑问，这种机制会一定程度鼓励交易。更多的交易和交易费可以充实矿工的收益，这是良性的。


### 哈希塑造

采用数据的哈希序列进行评比可能会出现一种攻击：

*通过向哈希源数据中加入随机的无用数据，即可改变哈希计算的结果，使其趋近于某种想要的目标*。此即：「**哈希塑造**」。

为避免这种攻击，需要对参与哈希计算的因子进行约束：不应当有可塑性，或成本高昂。


### 参与因子

#### 概念

- **铸凭交易**：有资格参与铸造评选的交易称为铸凭交易。
- **铸凭哈希**：以各种因子结合计算的哈希称为铸凭哈希，它是铸造竞争的直接对比值。
- **评参区块**：铸造竞争的源数据应当是动态的。我们用动态增长的链末端来表达，比如取末端某个负高度的区块的相关信息。
- **UTXO指纹**：UTXO是「Unspent Transaction Output」的缩写，可以用UTXO集的指纹来获得某种动态的确定性。
- **币权总值**：交易的 `币量*币龄` 的总和称为币权。一个区块收录的交易的币权总和可以作为一个动态的半确定性因子。

> **注：**
> 币金被交易花费后，其新输出的币龄为零。也即「币权销毁」。


#### 可塑性分析

*交易ID*是交易数据的哈希摘要，用户可以通过在交易里添加冗余数据来任意塑造交易ID。因此交易ID必须位于末端动态参考位置之前的区域，使得在交易创建时，没有信息可供针对，无法塑造。

*区块ID*的逻辑类似，铸造者也可以往Coinbase交易里填充信息（同时还能自由组织交易序列），因此不能采用。

UTXO集的*指纹*是当前区块链所有UTXO的总结，改变该指纹需要实际创建交易并花费，有交易费成本。**注**：UTXO指纹的计算包含了交易ID，因此其可塑性依然强大。

末端区块的*时间戳*是动态的，但区块创建有严格的时间间隔，因此时间戳没有可塑性。**注**：区块时间戳并非实际存在的字段，而是通过创始块时间戳和高度计算得出。

*铸凭哈希*是最终的计算结果，如果设计可行，铸凭哈希是市场化自由竞争的结果，是否可预期（或塑造）取决于算法本身是否合理。每一个区块都有自己的铸造者（也即铸凭哈希），动态的链末端逻辑可以提供随机的确定性。

**币权总值**由区块收录的全部交易决定，如果要改变币权总值，就需要改变区块所收录的交易。添加新的交易会有交易费成本，而移除交易则有交易费损失，因此币权总值的可塑性较低，或者说成本高昂。


### 规则

- 铸凭交易：有效区间为 `[-25 ~ -80000]` 号区块高度。设计截止时间可提供一种淘汰机制。
- 评参区块：取链末端的 `-9` 号区块。这是一个综合权衡的折衷值，考虑了时间长度（8*6=48 分钟）对参与者的友好性。
- 币权总值：取链末端的 `-24` 号区块的币权总值。与评参区块相距较远，以避免铸造者提前出现在择优池中的问题。
- 铸 造 者：取铸凭交易里*首笔输入*的接收者公钥地址。用已花费地址更安全，避免冷挖矿的需求。

淘汰机制可以让用户有机会抛弃过往（比如委托了不良的第三方），同时也让攻击者总是需要不断地积累新的资源……

> **注意：**
> 在一个区块形成前，其铸造者可能已经出现在择优池中了，
> 因为一个新区块创建后，它就会作为未来的评参区块被针对，竞争者据此评估自己的资格。


### 铸凭哈希

哈希计算应当用签名之后的数据进行，以隐藏交易ID本身，避免攻击者寻找和收买那些潜在的高权重者。

> **说明：**
> 下面的伪代码类似Go语言语法，但仅用于表意。

算法示意：

```go
Mix := 0x517cc1b727220a95        // 混合常数，增加Bit位复杂性
Stakes := -24号区块币权总值       // 按「聪*秒」计算汇总，最终精确到「币*天」
timeStamp := currentBlockTime    // 当前区块时间戳（Unix 毫秒）

X := Bytes(timeStamp * Stakes * Mix) // 转为字节序列

// 源数据：
// 这是公开的信息，攻击者可以探查或推算。
var hashData []byte = Hash( 铸凭交易ID || 评参区块:铸凭哈希 || X )

// 签名：
// 结果是私有的，攻击者没有私钥无法得知该结果。
var signData []byte = Sign( hashData )

// 铸凭哈希：
// 攻击者走不到这一步，因此无法判断哪个铸凭交易更优。
var hashMint []byte = Hash( signData )
```

评选简单地对比铸凭哈希序列，值小者胜出。

> **注记：**
> 用币权因子取代之前的UTXO指纹。优点：
> - 币权总值可塑性低且成本明确，辅以大奇数乘数，可弥补Bit位复杂性不足的问题。
> - 区块头内包含了币权销毁信息，检索更便捷，也更轻量高效。


#### 附：设计说明

对币权总值进行塑造，需要知道评参区块的铸造者，如果采用评参区块的币权总值，则其铸造者实际上已经出现在择优池中了（已知），因此可塑造。

所以必须选择更靠前的区块的币权总值，直到评参区块的铸造者不可知，且提供一定的余量，避免拥有大量交易的服务商预测区块的铸造者。`24-9-8=7`，大约7个区块的余量应该已经足够。

预估评参区块的铸造者（铸凭哈希）在没有交易ID塑造逻辑的情况下，成功的可能性并不高。因此*假设铸凭哈希已知然后塑造币权总值*的利益驱动就不强烈了。

币权总值的加入，是为了丰富参与因子并清除 *交易ID可塑造* 的逻辑——因为币权总值是动态的，且基本不可控。


### 初段规则

区块链最初创建的9个区块没有 `-9` 号评参区块，因此需要一些特别的处理。

涉及两个基本变量：

1. 评参区块高度获取。
2. 交易所在区块的高度的合法性。


#### 评参区块

因为铸造竞争源于交易ID，初期的交易只由区块链的创建者发布，没有攻击者，因此可以采用简单的算法如下：

```go
// 初段：
// 评参区块取创始块即可
// @currentHeight 当前区块高度
if currentHeight < 9 {
    return 0
}
// 后期：正常的取值。
return currentHeight - 9
```


#### 铸凭交易

源于同上没有攻击者的原因，区块创建者不需要塑造交易ID，因此简单地判断即可：

```go
// 初段：
// 交易所在区块高度是否合法。
// @currentHeight 当前区块高度
if currentHeight < 25 {
    return true
}
// 后期：正常的判断
// @txHeight 交易所在区块高度
h := currentHeight - txHeight
return h > 24 && h <= 80000
```

任何合法的交易ID皆可作为铸凭交易参与竞争。第25块之前的参与因子可灵活处理。


#### 百日扩张

基于交易历史的证明要求参与者已经是用户，这就需要把铸造的币金分发出去。除了公共服务可以从外部获取币金之外，对于初期的区块链成长，这里设计了一个百日扩张方案，供参考。

- `0号` 区块：*创始区块*。区块链启动。
- `1 - 10号` 区块：*私钥扩张*。创建适量的收益地址，用于之后的交易创建和铸凭交易竞争。
- `11 - 7200号` 区块（30日），*币金积累*。观察情况，保留随时停止区块链运行的可能性。
- `7201 - 24000号` 区块（百日）：*抽奖扩张*。由社区推广活动收集地址，由积累的币金发放奖励，扩展初期铸凭交易规模。

至此，铸币交易（Coinbase）中只有一笔输出，无公共服务奖励。此期间依然保留观察区块链运行以及停止的权利。

- `101日 ~`：接受公共服务，启动对外奖励。进入正常的自由市场……

> **注：**
> 百日期间每交易输出项数量应当不超过输入数量的**2**倍，以约束扩张速度。



## 铸造者的预选

因为评参区块是链末端 `-9号` 区块，所以一个铸造候选者最多可提前 `8个` 区块时段得知要对比的目标。如果一个节点及时评估并广播自己的铸凭交易（及其凭证），则全网会有充足的时间进行预先沟通。尽量多的参与者加入，可以使尽可能优质的铸凭交易被发掘出来。


### 择优池

在铸造候选者的预先沟通中，各个节点会收集广播出来的铸凭交易，按品质排序放入一个缓存池，这个缓存池就是 **择优池**。择优池实际上是一个池集，因为每一个评参区块都对应一个择优池。

新的铸凭交易加入择优池的逻辑很简单：计算其铸凭哈希，如果比池中最差的一个好，则有序插入并转播，否则忽略。


### 择优凭证

铸造候选者的证明包含如下几项信息：

- 交易定位：年度、交易ID。
- 铸造者：  首笔输入的接收者公钥。
- 签名数据：铸造者对铸凭交易演算数据的签名（见前 `signData`）。
- 铸凭哈希：即 `Hash(signData)`，可选。

铸凭哈希由签名数据计算而来，最终的铸造者凭证会存储在区块的`Coinbase`交易中，用于铸造者资格证明。


#### 附：铸造者来源合法性验证

0. 首先核实交易ID的合法性。**注**：区块头链为验证终点（每个客户端都持有此信息）。
1. 根据交易ID检索其交易头信息、输入段信息（首领输入+剩余输入段哈希）和输出段根哈希。
2. 根据上面的信息验证交易ID是否匹配（**注**：从外部检索的交易ID需要核实）。

3. 根据首领输入（年度+交易ID+输出序位）检索其来源输出项数据（含公钥地址），以及哈希认证路径（类默克尔路径）。
4. 根据上面的信息验证首领输入的交易ID合法。

5. 核验首领输入数据里的接收者公钥哈希是否匹配择优凭证中的公钥？
6. 根据公钥验证择优凭证里的签名（以及铸凭哈希）。

> **注：**
> 作为一种可能的优化，铸造竞争者也可以自己传递其首领输入来源交易ID的证明材料，
> 这样就可以避免验证节点对该交易信息的二次检索，直接验证即可。


### 择优池同步

为避免刚上线的优质竞争者带来扰乱（引起分叉），动态更新的择优池需要在各节点间提前确定下来（获得确定性），这就是择优池的同步。同步可以合并各个择优池，优化择优池成员，提升竞争力。

一个新区块在成为评参区块（`-9号`）之前，铸造竞争有如下分段逻辑：

1. **广播收集**：新区块创建后，到它成为 `-7号` 区块前，有**6**个区块时段可以对铸凭交易计算铸凭哈希，广播并优选。
2. **同步优化**：当该区块成为 `-7号` 区块后，择优池的更新结束，进入同步期。耗时**2**个区块时段。
3. **抵达结束**：当该区块成为 `-9号` 区块后，即成为当前待创建区块的*评参区块*。此时其择优池中的候选者已确定。


#### 广播收集

除了接收铸凭交易的广播和评估外，此阶段节点还会彼此沟通择优池状况，以期最优化择优池成员。

因此在进入同步阶段后，大部分节点的目标区块的择优池情况应该都差异不大。


#### 授权节点

择优池大小设计为 `20`，有权同步的节点为择优池中 `后15` 名成员。这基于利益无关性考虑：

*在P2P环境下，时间无法准确约束，如果没有限制，优质的迟到竞争者可以随时把自己加入择优池。这会导致同步工作难以正常结束。*

有了此授权节点约束，如果优质的候选者迟到了，排名靠后的节点没有动力去把它额外补入。而一个中等优质的迟到者也没有动机把自己加到择优池，然后开启新的同步，因为它基本不可能成为铸造者，并且即便开启同步，也影响不大。

> **注**：一个授权节点只有一次同步的权力。


#### 同步优化

此阶段使用择优池后段成员的择优池相互补充，合并优化，并同化到全网。

同步的择优池称为**同步池**，作为一个整体由该池中合法的授权节点签名并广播。接收同步的节点会另外创建一个**合并池**，接受同步池，验证并合并。

同步池是否合法由以下规则判断：

1. 签名者是否在自己的择优池中（不论排名如何），或者是否在*合并池*中。
2. 签名者在其发布的*同步池*中是否位于后段15位中。

上面的检查通过后，接收其数据，验证并合并到*合并池*内。对于一个新上线节点的首次同步，可以先忽略条件1。

这是一种P2P下概略的同步&合并，无法有精确的约束。同步工作也只处理有限的数据（大概15位成员的择优池），因此择优池的品质由广播阶段保证。

最终，**合并池**会替换节点自己的目标区块的择优池。



## 设计参数

- 铸凭交易的区块有效范围：`[-80000, -25]`（约11个月）。
- 择优池容量为 `20名` 候选者，内部按铸凭哈希字节序列从小到大排列（值小者优）。
- 择优池中排序在前5名之后的 `15位` 候选者有权发起择优池同步。




--------------------------------------------------------------------------

上一篇：[要点](0.要点.md)<br>
下一篇：[共识：端点约定](2.共识-端点约定.md)<br>
